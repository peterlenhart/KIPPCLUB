<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>FAIRY KIPP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link
    href="https://fonts.googleapis.com/css2?family=Pacifico&family=Montserrat:wght@500;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root{
      --fk-blue: rgb(0, 101, 171);
      --fk-violet: rgb(170, 0, 120);
      --fk-green: rgb(59, 165, 43);
      --fk-orange: rgb(242, 150, 0);

      --fk-bg:#111111;
      --fk-panel:#1b1b1b;
      --fk-text:#f5f5f5;
      --fk-muted:#bbbbbb;
      --fk-border:#333333;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      background: radial-gradient(circle at top, #222 0, #000 55%, #000 100%);
      color: var(--fk-text);
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:stretch;
      padding:12px;
    }

    .app{
      width:100%;
      max-width:480px;
      background:var(--fk-bg);
      border-radius:18px;
      border:1px solid var(--fk-border);
      box-shadow:0 0 30px rgba(0,0,0,0.7);
      padding:14px 14px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .header{ text-align:center; margin-bottom:4px; }
    .logo-line{ display:inline-flex; align-items:baseline; gap:6px; }
    .logo-fairy{
      font-family:"Pacifico",cursive;
      font-size:1.8rem;
      letter-spacing:0.05em;
      color:var(--fk-orange);
      text-shadow:0 0 6px rgba(242,150,0,0.8);
    }
    .logo-kipp{
      font-weight:700;
      font-size:1.4rem;
      letter-spacing:0.2em;
      color:var(--fk-blue);
      text-transform:uppercase;
    }
    .tagline{
      margin-top:4px;
      font-size:0.8rem;
      color:var(--fk-muted);
    }

    .panel{
      background:var(--fk-panel);
      border-radius:14px;
      border:1px solid var(--fk-border);
      padding:10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .button-row{
      display:flex;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
    }

    button{ border:none; cursor:pointer; font-family:inherit; }

    .btn-main{
      min-width:160px;
      padding:10px 16px;
      border-radius:10px;
      font-size:1rem;
      font-weight:700;
      letter-spacing:0.08em;
      text-transform:uppercase;
      background-color:var(--fk-orange);
      color:#111;
      box-shadow:0 0 12px rgba(242,150,0,0.7);
      transition:transform 0.08s ease-out, box-shadow 0.08s ease-out, filter 0.08s ease-out;
    }
    .btn-main:active{
      transform:translateY(1px) scale(0.98);
      box-shadow:0 0 3px rgba(242,150,0,0.6);
      filter:brightness(0.95);
    }

    .btn-secondary{
      min-width:200px;
      padding:10px 16px;
      border-radius:12px;
      font-size:0.95rem;
      font-weight:800;
      letter-spacing:0.08em;
      text-transform:uppercase;
      background-color:var(--fk-blue);
      color:#fdfdfd;
      box-shadow:0 0 12px rgba(0,101,171,0.5);
      transition:transform 0.08s ease-out, box-shadow 0.08s ease-out, filter 0.08s ease-out;
    }
    .btn-secondary:active{
      transform:translateY(1px) scale(0.98);
      box-shadow:0 0 3px rgba(0,101,171,0.6);
      filter:brightness(0.95);
    }

    .btn-ghost{
      padding:6px 10px;
      border-radius:10px;
      font-size:0.72rem;
      border:1px solid rgba(255,255,255,0.12);
      background:transparent;
      color:rgba(255,255,255,0.75);
      text-transform:uppercase;
      letter-spacing:0.1em;
    }
    .btn-ghost:active{ filter:brightness(0.9); }

    .btn-disabled{
      opacity:0.40;
      cursor:not-allowed;
      filter:grayscale(0.25);
    }

    .microline{
      min-height:0.8em;
      font-size:0.75rem;
      color:transparent;
      text-align:center;
      user-select:none;
    }

    .story-box{
      min-height:130px;
      max-height:210px;
      border-radius:10px;
      border:1px solid var(--fk-border);
      padding:12px 16px;
      font-size:1.35rem;
      line-height:1.7;
      background: radial-gradient(circle at top left, #252525 0, #111 55%);
      overflow-y:auto;
      text-align:center;
      user-select:none;
      position:relative;
    }

    .story-box.final-pop{
      border-color:transparent;
      background: radial-gradient(circle at top, #1f1f1f 0, #0c0c0c 60%);
      box-shadow:0 0 18px rgba(242,150,0,0.10);
    }

    .archive-target{
      position:sticky;
      top:0;
      display:none;
      text-align:center;
      font-size:0.9rem;
      letter-spacing:0.06em;
      text-transform:uppercase;
      padding-bottom:8px;
      margin-bottom:10px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      color:rgba(245,245,245,0.62);
      background:rgba(0,0,0,0.0);
    }
    .archive-target.show{ display:block; }

    #story-text{
      width:100%;
      white-space:pre-wrap;
      font-weight:650;
    }

    .story-muted{
      color:var(--fk-muted);
      font-style:italic;
      font-size:0.95rem;
      font-weight:450;
    }

    .hintline{
      min-height:1.2em;
      text-align:center;
      font-size:0.9rem;
      font-weight:700;
      letter-spacing:0.10em;
      text-transform:uppercase;
      color:rgba(245,245,245,0.72);
      margin-top:2px;
      user-select:none;
    }
    .hintline.hidden{ display:none; }

    .score-value{
      text-align:center;
      font-size:2.4rem;
      font-weight:900;
      letter-spacing:0.06em;
      color:#fff;
      line-height:1.0;
      text-shadow:0 0 10px rgba(0,0,0,0.7);
    }

    /* API banner */
    .apikey-banner{
      position:fixed;
      top:8px;
      left:0; right:0;
      display:flex;
      justify-content:center;
      z-index:50;
      pointer-events:none;
    }
    .apikey-inner{
      pointer-events:auto;
      background:#151515;
      border-radius:999px;
      border:1px solid var(--fk-border);
      padding:6px 10px;
      display:flex;
      align-items:center;
      gap:6px;
      max-width:480px;
      width:calc(100% - 24px);
      box-shadow:0 0 14px rgba(0,0,0,0.7);
      font-size:0.75rem;
    }
    .apikey-inner span{ white-space:nowrap; }
    .apikey-input{
      flex:1;
      padding:4px 6px;
      border-radius:999px;
      border:1px solid var(--fk-border);
      background:#111;
      color:#f5f5f5;
      font-size:0.8rem;
      min-width:0;
    }
    .apikey-btn{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--fk-violet);
      background:var(--fk-violet);
      color:#fff;
      font-size:0.75rem;
      cursor:pointer;
    }
    .apikey-btn:active{ filter:brightness(0.9); }

    .hidden{ display:none !important; }

    /* Mini-Confirm-Bar (unten, klein) */
    .mini-confirm{
      display:none;
      justify-content:center;
      gap:10px;
      margin-top:4px;
    }
    .mini-square{
      width:44px;
      height:44px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.06);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:1.2rem;
      font-weight:900;
      color:rgba(245,245,245,0.92);
    }
    .mini-square:active{ filter:brightness(0.9); }
    .mini-square.ok{
      border-color:rgba(59,165,43,0.55);
      box-shadow:0 0 10px rgba(59,165,43,0.18);
    }
    .mini-square.no{
      border-color:rgba(255,255,255,0.18);
    }

    .footer-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:2px;
      opacity:0.85;
    }
  </style>
</head>

<body>
  <div class="apikey-banner" id="apikey-banner">
    <div class="apikey-inner">
      <span>OpenAI&nbsp;API-Key:</span>
      <input id="apikey-input" class="apikey-input" type="password" placeholder="sk-..." />
      <button class="apikey-btn" id="apikey-save-btn">OK</button>
    </div>
  </div>

  <div class="app">
    <header class="header">
      <div class="logo-line">
        <span class="logo-fairy">Fairy</span>
        <span class="logo-kipp">KIPP</span>
      </div>
      <div class="tagline">Unendlich viele KIPP-Geschichten</div>
    </header>

    <!-- Story / Ablauf -->
    <section class="panel">
      <div class="button-row">
        <button id="fairy-btn" class="btn-main">FAIRY</button>
      </div>
      <div class="microline">.</div>

      <div class="story-box" id="story-box">
        <div id="archive-target" class="archive-target"></div>
        <div id="story-text" class="story-muted">
          Tippe auf <strong>FAIRY</strong>, um eine neue Geschichte zu starten.
        </div>
      </div>

      <div id="hintline" class="hintline hidden">noch 1 kipp</div>
    </section>

    <!-- Punkte + Aktionen -->
    <section class="panel">
      <div class="score-value" id="score-value">0</div>

      <div class="button-row" style="margin-top: 8px;">
        <button id="erkippt-btn" class="btn-secondary">FAIRY ERKIPPT</button>
      </div>

      <!-- kleine Sicherheitsabfrage (Haken / Kreuz) -->
      <div class="mini-confirm" id="mini-confirm">
        <button class="mini-square ok" id="mini-ok" aria-label="Bestätigen">✓</button>
        <button class="mini-square no" id="mini-no" aria-label="Abbrechen">✕</button>
      </div>

      <!-- unscheinbar unten -->
      <div class="footer-row">
        <button id="newgame-btn" class="btn-ghost">NEUES SPIEL</button>
        <button id="back-btn" class="btn-ghost">ZUR STARTSEITE</button>
      </div>
    </section>
  </div>

  <script>
    // -----------------------------
    // Konfiguration
    // -----------------------------
    const OPENAI_CHAT_URL = "https://api.openai.com/v1/chat/completions";
    const OPENAI_MODEL = "gpt-4o-mini";
    const APIKEY_STORAGE_KEY = "fairykipp_openai_key";

    const WIN_POINTS = 6;

    // Motive
    const motifsData = [
      { key: "Wasserball",  article: "der",  noun: "Wasserball"  },
      { key: "Auto",        article: "das",  noun: "Auto"        },
      { key: "Farbfleck",   article: "der",  noun: "Farbfleck"   },
      { key: "Buch",        article: "das",  noun: "Buch"        },
      { key: "Gießkanne",   article: "die",  noun: "Gießkanne"   },
      { key: "Kerze",       article: "die",  noun: "Kerze"       },
      { key: "Blume",       article: "die",  noun: "Blume"       },
      { key: "Fisch",       article: "der",  noun: "Fisch"       },
      { key: "Schmetterling", article: "der", noun: "Schmetterling" },
      { key: "Schuh",       article: "der",  noun: "Schuh"       },
      { key: "Tasse",       article: "die",  noun: "Tasse"       },
      { key: "T-Shirt",     article: "das",  noun: "T-Shirt"     }
    ];

    // Farb-Adjektive (nur diese!)
    const colorsData = ["grüne", "blaue", "violette", "orangefarbene"];

    // Lautverben je Motiv
    const motifVerbBase = {
      Wasserball: ["platschte","plumpste","spritzte","hüpfte","polterte","ploppte"],
      Auto: ["brummte","knatterte","röhrte","tuckerte","schnurrte","hupte","quietschte","dröhnte","heulte","fauchte"],
      Farbfleck: ["tropfte","kleckste","spritzte","schmierte","kleckerte","schmatzte"],
      Buch: ["raschelte","blätterte","murmelte","seufzte","flüsterte","knisterte","wisperte","brummte","klappte"],
      Gießkanne: ["plätscherte","tropfte","gluckerte","schwappte","gluckste","schwallte","gurgelte"],
      Kerze: ["flackerte","knisterte","zischte","glomm","flüsterte","seufzte","hauchte"],
      Blume: ["flüsterte","hauchte","seufzte","wisperte","raschelte","murmelte","säuselte","flötete"],
      Fisch: ["blubberte","gluckerte","sprudelte","murmelte","schmatzte","zischte","schlürfte","schwapperte","gluckste"],
      Schmetterling: ["flüsterte","wisperte","hauchte","seufzte","säuselte","murmelte","kicherte","trillierte","zirpte"],
      Schuh: ["quietschte","klackte","schlurfte","knirschte","tappte","stapfte","polterte","scharrte","knarzte"],
      Tasse: ["klirrte","klimperte","klackte","knackte","zitterte","murmelte","summte","brummte","seufzte"],
      "T-Shirt": ["raschelte","flatterte","seufzte","wisperte","knisterte","murmelte","hauchte","säuselte"]
    };

    // -----------------------------
    // UI
    // -----------------------------
    const fairyBtn = document.getElementById("fairy-btn");
    const storyBox = document.getElementById("story-box");
    const archiveTargetEl = document.getElementById("archive-target");
    const storyTextEl = document.getElementById("story-text");
    const hintlineEl = document.getElementById("hintline");

    const scoreValueEl = document.getElementById("score-value");
    const erkipptBtn = document.getElementById("erkippt-btn");

    const miniConfirm = document.getElementById("mini-confirm");
    const miniOk = document.getElementById("mini-ok");
    const miniNo = document.getElementById("mini-no");

    const newGameBtn = document.getElementById("newgame-btn");
    const backBtn = document.getElementById("back-btn");

    const apikeyBanner = document.getElementById("apikey-banner");
    const apikeyInput = document.getElementById("apikey-input");
    const apikeySaveBtn = document.getElementById("apikey-save-btn");

    // -----------------------------
    // Zustand
    // -----------------------------
    let apiKey = null;

    let unusedMotifs = [];
    let unusedVerbsByMotif = {};

    let currentMotif = null;
    let currentVerb = null;
    let currentColor = null;

    let currentStoryFullPlain = "";
    let currentTailPlain = "";
    let currentTailHtml = "";
    let currentChunks = [];
    let currentChunkIndex = -1;

    // Phasen:
    // idle: keine aktive Fairy
    // reading: 1..11
    // final: 12 (kurz Pop)
    // waiting: Ziel steht oben, jetzt darf "Fairy erkippt" Punkte geben
    let phase = "idle";

    let score = 0;

    // "Punkt vergeben?" nur wenn waiting + Ziel existiert
    let confirmArmed = false;

    // -----------------------------
    // Helpers
    // -----------------------------
    function shuffleArray(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function initUnusedMotifs(){
      unusedMotifs = motifsData.slice();
    }

    function chooseMotifNoImmediateRepeat(){
      if(unusedMotifs.length===0) initUnusedMotifs();
      const idx = Math.floor(Math.random()*unusedMotifs.length);
      const motif = unusedMotifs[idx];
      unusedMotifs.splice(idx,1);
      return motif;
    }

    function getAllowedVerbsForMotif(noun){
      const base = motifVerbBase[noun];
      return base ? base.slice() : [];
    }

    function initUnusedVerbsForMotif(noun){
      unusedVerbsByMotif[noun] = shuffleArray(getAllowedVerbsForMotif(noun));
    }

    function chooseVerbForMotif(noun){
      if(!unusedVerbsByMotif[noun] || unusedVerbsByMotif[noun].length===0){
        initUnusedVerbsForMotif(noun);
      }
      return unusedVerbsByMotif[noun].pop();
    }

    function loadApiKeyFromStorage(){
      const stored = window.localStorage.getItem(APIKEY_STORAGE_KEY);
      if(stored && stored.startsWith("sk-")){
        apiKey = stored;
        apikeyBanner.classList.add("hidden");
      }else{
        apiKey = null;
        apikeyBanner.classList.remove("hidden");
      }
    }

    function saveApiKeyToStorage(key){
      apiKey = key;
      window.localStorage.setItem(APIKEY_STORAGE_KEY, key);
      apikeyBanner.classList.add("hidden");
    }

    function updateScoreDisplay(){
      scoreValueEl.textContent = String(score);
    }

    function setHint(text){
      if(!text){
        hintlineEl.classList.add("hidden");
        hintlineEl.textContent="";
        return;
      }
      hintlineEl.textContent=text;
      hintlineEl.classList.remove("hidden");
    }

    function setArchiveTarget(htmlOrEmpty){
      if(!htmlOrEmpty){
        archiveTargetEl.innerHTML="";
        archiveTargetEl.classList.remove("show");
        return;
      }
      archiveTargetEl.innerHTML = htmlOrEmpty;
      archiveTargetEl.classList.add("show");
    }

    function setStoryMuted(html){
      storyTextEl.classList.add("story-muted");
      storyTextEl.innerHTML = html;
    }
    function setStoryPlain(text){
      storyTextEl.classList.remove("story-muted");
      storyTextEl.textContent = text;
    }
    function setStoryHtml(html){
      storyTextEl.classList.remove("story-muted");
      storyTextEl.innerHTML = html;
    }

    function setButtonMode(mode){
      // "FAIRY" | "WEITER" | "HIDE"
      if(mode==="HIDE"){
        fairyBtn.classList.add("hidden");
        return;
      }
      fairyBtn.classList.remove("hidden");
      fairyBtn.textContent = mode;
    }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function getCssColorForAdj(adj){
      if(!adj) return null;
      const clean = adj.toLowerCase().replace(/[.,!?:;"“”„]+$/g,"");
      switch(clean){
        case "blaue": return "var(--fk-blue)";
        case "grüne": return "var(--fk-green)";
        case "violette": return "var(--fk-violet)";
        case "orangefarbene": return "var(--fk-orange)";
        default: return null;
      }
    }

    function highlightTailColor(tailPlain, adjective){
      const cssColor = getCssColorForAdj(adjective);
      if(!cssColor) return escapeHtml(tailPlain);

      const escapedAdj = adjective.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");
      const regex = new RegExp(`\\b(${escapedAdj})\\b`,"i");
      const safe = escapeHtml(tailPlain);
      return safe.replace(regex, `<span style="color:${cssColor}">$1</span>`);
    }

    function splitWordsBalanced(text, n){
      const words = text.trim().split(/\s+/).filter(Boolean);
      if(words.length===0) return Array.from({length:n},()=> "");

      const totalLen = words.reduce((acc,w)=> acc + w.length + 1, 0);
      const target = Math.max(1, Math.round(totalLen / n));

      const chunks = [];
      let cur = [];
      let curLen = 0;

      for(const w of words){
        const addLen = w.length + (cur.length ? 1 : 0);

        if(chunks.length < n-1 && cur.length>0 && (curLen + addLen) > target){
          chunks.push(cur.join(" "));
          cur = [w];
          curLen = w.length;
        }else{
          cur.push(w);
          curLen += addLen;
        }
      }

      chunks.push(cur.join(" "));

      while(chunks.length < n) chunks.push("");
      while(chunks.length > n){
        const a = chunks.pop();
        chunks[chunks.length-1] = (chunks[chunks.length-1] + " " + a).trim();
      }

      return chunks;
    }

    function buildTwelfthsVisually(fullPlain, tailPlain, colorAdj){
      let head = fullPlain.trim();
      const tail = tailPlain.trim();

      if(head.endsWith(tail)){
        head = head.slice(0, head.length - tail.length).trim();
      }else{
        const idx = head.lastIndexOf(tail);
        if(idx !== -1) head = head.slice(0, idx).trim();
      }

      const first11 = splitWordsBalanced(head, 11);
      const tailHtml = highlightTailColor(tailPlain, colorAdj);
      return [...first11, tailHtml];
    }

    function hideMiniConfirm(){
      miniConfirm.style.display = "none";
      confirmArmed = false;
    }
    function showMiniConfirm(){
      miniConfirm.style.display = "flex";
      confirmArmed = true;
    }

    function setEndUI(){
      setButtonMode("HIDE");
      erkipptBtn.classList.add("btn-disabled");
      erkipptBtn.disabled = true;
      hideMiniConfirm();
      setHint("");
      setStoryMuted(`Spielende.<br>Jemand hat <strong>${WIN_POINTS}</strong> Punkte erreicht.`);
    }

    function resetRoundToIdle(){
      currentMotif=null;
      currentVerb=null;
      currentColor=null;
      currentStoryFullPlain="";
      currentTailPlain="";
      currentTailHtml="";
      currentChunks=[];
      currentChunkIndex=-1;

      setArchiveTarget("");
      storyBox.classList.remove("final-pop");
      setHint("");
      setButtonMode("FAIRY");
      phase="idle";
      hideMiniConfirm();

      setStoryMuted(`Tippe auf <strong>FAIRY</strong>, um eine neue Geschichte zu starten.`);
    }

    // -----------------------------
    // OpenAI: neue Fairy
    // -----------------------------
    async function generateNewFairyAndShowFirstTwelfth(retryCount=0){
      if(!apiKey){
        apikeyBanner.classList.remove("hidden");
        return;
      }
      if(score >= WIN_POINTS){
        setEndUI();
        return;
      }

      setButtonMode("HIDE");
      setHint("");
      storyBox.classList.remove("final-pop");
      setArchiveTarget("");
      hideMiniConfirm();
      setStoryMuted("… KI zaubert eine neue Geschichte …");

      const motifObj = chooseMotifNoImmediateRepeat();
      const verb = chooseVerbForMotif(motifObj.noun);
      const color = colorsData[Math.floor(Math.random()*colorsData.length)];

      currentMotif = motifObj;
      currentVerb = verb;
      currentColor = color;

      const systemMessage = {
        role:"system",
        content:
          "Du schreibst sehr kurze Fabeltexte auf Deutsch für ein Gesellschaftsspiel.\n" +
          "Du MUSST GENAU zwei Sätze liefern, insgesamt etwa 18–28 Wörter.\n" +
          "Regeln:\n" +
          "- Schreibe in der dritten Person.\n" +
          "- Verwende keine weiteren Farbwörter im Text.\n" +
          "- Verwende das Motivwort NICHT.\n" +
          "- Kein Genitiv.\n" +
          "- Kein 'sagte', 'meinte', 'dachte'.\n"
      };

      const userMessage = {
        role:"user",
        content:
          "Die unsichtbare Hauptfigur dieser Fabel ist: \""+motifObj.noun+"\".\n" +
          "Schreibe GENAU zwei zusammenhängende Sätze, insgesamt ca. 18–28 Wörter.\n" +
          "Der erste Satz beschreibt die Situation, ohne das Wort \""+motifObj.noun+"\".\n" +
          "Der zweite Satz besteht nur aus wörtlicher Rede und endet mit einem abschließenden Anführungszeichen und einem Satzzeichen (. ? oder !).\n" +
          "Nach dem zweiten Satz darf in deiner Antwort nichts Inhaltliches mehr folgen.\n"
      };

      try{
        const response = await fetch(OPENAI_CHAT_URL,{
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            Authorization:"Bearer "+apiKey
          },
          body: JSON.stringify({
            model: OPENAI_MODEL,
            messages:[systemMessage, userMessage],
            temperature:0.8,
            max_tokens:220
          })
        });

        if(!response.ok) throw new Error("HTTP-Fehler: "+response.status);

        const data = await response.json();
        let text = data.choices?.[0]?.message?.content?.trim() || "";
        text = text.replace(/\s+/g," ").trim();

        const dotIdx = text.lastIndexOf(".");
        const exIdx  = text.lastIndexOf("!");
        const qIdx   = text.lastIndexOf("?");
        const lastPunctIdx = Math.max(dotIdx, exIdx, qIdx);

        const tailPlain = `${motifObj.article} ${color} ${motifObj.noun}`;
        let baseText;

        if(lastPunctIdx === -1){
          if(retryCount < 3) return await generateNewFairyAndShowFirstTwelfth(retryCount+1);
          baseText = 'Etwas Unbenanntes wartete geduldig am Rand des Spielfelds. "Jetzt kommt mein Moment!"';
        }else{
          baseText = text.slice(0, lastPunctIdx + 1).trimRight();
        }

        const storyPlain = `${baseText} ${verb} ${tailPlain}`.replace(/\s+/g," ").trim();

        currentStoryFullPlain = storyPlain;
        currentTailPlain = tailPlain;
        currentTailHtml  = highlightTailColor(currentTailPlain, color);

        currentChunks = buildTwelfthsVisually(currentStoryFullPlain, currentTailPlain, color);

        currentChunkIndex = 0;
        phase = "reading";
        setButtonMode("WEITER");
        setStoryPlain(currentChunks[0] || "");
      }catch(err){
        console.error(err);
        setButtonMode("FAIRY");
        setStoryMuted("Die Fairy hat sich im Nebel verirrt. Prüfe bitte Internet und API-Key.");
        phase="idle";
      }
    }

    function showNextChunkOrFinal(){
      if(!currentChunks || currentChunks.length !== 12) return;

      if(phase==="reading"){
        const next = currentChunkIndex + 1;

        if(next <= 10){
          currentChunkIndex = next;
          setStoryPlain(currentChunks[currentChunkIndex] || "");
          return;
        }

        // Zwölftel 12 (Pop)
        currentChunkIndex = 11;
        phase = "final";
        setButtonMode("HIDE");
        setHint("");
        storyBox.classList.add("final-pop");
        setArchiveTarget("");

        setStoryHtml(`
          <div style="
            font-size: clamp(1.8rem, 7vw, 2.35rem);
            font-weight: 900;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            line-height: 1.15;
            padding-top: 10px;
            padding-bottom: 8px;">
            ${currentTailHtml}
          </div>
        `);

        setHint("noch 1 kipp");

        setTimeout(() => {
          // Ziel bleibt oben (Archiv)
          setArchiveTarget(currentTailHtml);

          // Hauptfläche ruhig
          setStoryMuted(" ");
          storyBox.classList.remove("final-pop");

          // Jetzt ist die Runde im Kipp-Teil: "Fairy erkippt" darf Punkte geben
          phase = "waiting";
          setHint("");
          setButtonMode("FAIRY"); // bleibt sichtbar, soll aber in waiting nichts auslösen
        }, 3200);
      }
    }

    // -----------------------------
    // Punkte: Fairy erkippt (nur wenn waiting)
    // -----------------------------
    function onErkipptClick(){
      if(score >= WIN_POINTS) return;

      // Nur gültig, wenn Ziel steht (waiting)
      if(phase !== "waiting") return;

      // Toggle: Mini-Confirm anzeigen
      if(!confirmArmed){
        showMiniConfirm();
      }else{
        // wenn schon offen, nochmal klicken = ignorieren (verhindert Doppelklick)
      }
    }

    function confirmPoint(){
      if(!confirmArmed) return;
      if(phase !== "waiting") { hideMiniConfirm(); return; }
      if(score >= WIN_POINTS) { hideMiniConfirm(); return; }

      score += 1;
      updateScoreDisplay();
      hideMiniConfirm();

      if(score >= WIN_POINTS){
        setEndUI();
        return;
      }

      // Nach Punktvergabe: neue Runde
      resetRoundToIdle();
    }

    function cancelPoint(){
      hideMiniConfirm();
    }

    // -----------------------------
    // New Game
    // -----------------------------
    function startNewGame(){
      score = 0;
      updateScoreDisplay();
      erkipptBtn.disabled = false;
      erkipptBtn.classList.remove("btn-disabled");
      resetRoundToIdle();
    }

    // -----------------------------
    // Events
    // -----------------------------
    fairyBtn.addEventListener("click", async () => {
      if(score >= WIN_POINTS) return;

      if(phase === "idle"){
        await generateNewFairyAndShowFirstTwelfth();
        return;
      }

      if(phase === "reading"){
        showNextChunkOrFinal();
        return;
      }

      // phase === "waiting": FAIRY soll nichts machen (Ziel muss stehen bleiben)
    });

    erkipptBtn.addEventListener("click", () => {
      if(erkipptBtn.disabled) return;
      onErkipptClick();
    });

    miniOk.addEventListener("click", () => confirmPoint());
    miniNo.addEventListener("click", () => cancelPoint());

    newGameBtn.addEventListener("click", () => startNewGame());
    backBtn.addEventListener("click", () => { window.location.href = "index.html"; });

    apikeySaveBtn.addEventListener("click", () => {
      const val = apikeyInput.value.trim();
      if(!val || !val.startsWith("sk-")){
        alert("Bitte einen gültigen OpenAI-API-Key eingeben (beginnt mit 'sk-').");
        return;
      }
      saveApiKeyToStorage(val);
    });

    apikeyInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter") apikeySaveBtn.click();
    });

    // -----------------------------
    // Init
    // -----------------------------
    function init(){
      loadApiKeyFromStorage();
      initUnusedMotifs();
      updateScoreDisplay();
      resetRoundToIdle();
    }
    init();
  </script>
</body>
</html>
