<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>FAIRY KIPP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link
    href="https://fonts.googleapis.com/css2?family=Pacifico&family=Montserrat:wght@500;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --fk-blue: rgb(0, 101, 171);
      --fk-violet: rgb(170, 0, 120);
      --fk-green: rgb(59, 165, 43);
      --fk-orange: rgb(242, 150, 0);

      --fk-bg: #0e0e0e;
      --fk-panel: #151515;
      --fk-text: #f5f5f5;
      --fk-muted: #bbbbbb;
      --fk-border: #2b2b2b;

      --fk-soft: rgba(255,255,255,0.10);
      --fk-soft2: rgba(255,255,255,0.06);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: radial-gradient(circle at top, #222 0, #000 55%, #000 100%);
      color: var(--fk-text);
      font-family: "Montserrat", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 12px;
    }

    .app {
      width: 100%;
      max-width: 480px;
      background: var(--fk-bg);
      border-radius: 18px;
      border: 1px solid var(--fk-border);
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.75);
      padding: 14px 14px 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
    }

    .header { text-align: center; margin-bottom: 4px; }

    .logo-line {
      display: inline-flex;
      align-items: baseline;
      gap: 6px;
    }

    .logo-fairy {
      font-family: "Pacifico", cursive;
      font-size: 1.8rem;
      letter-spacing: 0.05em;
      color: var(--fk-orange);
      text-shadow: 0 0 10px rgba(242, 150, 0, 0.55);
    }

    .logo-kipp {
      font-family: "Montserrat", sans-serif;
      font-weight: 700;
      font-size: 1.4rem;
      letter-spacing: 0.2em;
      color: var(--fk-blue);
      text-transform: uppercase;
      text-shadow: 0 0 10px rgba(0, 101, 171, 0.35);
    }

    .tagline {
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--fk-muted);
    }

    .panel {
      background: radial-gradient(circle at top, rgba(255,255,255,0.05) 0, rgba(255,255,255,0.02) 45%, rgba(0,0,0,0) 100%),
                  var(--fk-panel);
      border-radius: 14px;
      border: 1px solid var(--fk-border);
      padding: 10px 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .button-row {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    button { border: none; cursor: pointer; font-family: inherit; }

    .btn-main {
      min-width: 160px;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 1rem;
      font-weight: 800;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      background-color: var(--fk-orange);
      color: #111;
      box-shadow: 0 0 14px rgba(242, 150, 0, 0.55);
      transition: transform 0.08s ease-out, filter 0.08s ease-out;
    }

    .btn-main:active { transform: translateY(1px) scale(0.98); filter: brightness(0.95); }

    .btn-action {
      min-width: 190px;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 0.92rem;
      font-weight: 900;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      background: transparent;
      border: 2px solid rgba(255,255,255,0.20);
      color: rgba(245,245,245,0.92);
      box-shadow: 0 0 16px rgba(0,0,0,0.35);
      transition: transform 0.08s ease-out, filter 0.08s ease-out, opacity 0.15s ease-out;
    }
    .btn-action:active { transform: translateY(1px) scale(0.99); filter: brightness(0.95); }
    .btn-action[disabled] { opacity: 0.35; cursor: default; }

    .btn-ghost {
      align-self: center;
      margin-top: 0px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.78rem;
      border: 1px solid rgba(255,255,255,0.16);
      background: transparent;
      color: rgba(255,255,255,0.78);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .btn-ghost:active { filter: brightness(0.9); }

    /* Story box */
    .story-box {
      min-height: 140px;
      max-height: 230px;
      border-radius: 14px;
      border: 1px solid var(--fk-border);
      padding: 14px 16px;
      font-size: 1.35rem;
      line-height: 1.7;
      background: radial-gradient(circle at top left, rgba(255,255,255,0.06) 0, rgba(255,255,255,0.02) 50%, rgba(0,0,0,0) 100%),
                  radial-gradient(circle at top left, #1b1b1b 0, #0f0f0f 60%);
      overflow-y: auto;
      text-align: center;
      user-select: none;
      position: relative;
    }

    .archive-target {
      position: sticky;
      top: 0;
      display: none;
      text-align: center;
      font-size: 0.92rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding-bottom: 10px;
      margin-bottom: 10px;
      border-bottom: 1px solid var(--fk-soft2);
      color: rgba(245,245,245,0.70);
      background: rgba(0,0,0,0.0);
    }
    .archive-target.show { display: block; }

    #story-text {
      width: 100%;
      white-space: pre-wrap;
      font-weight: 700;
    }
    .story-muted {
      color: rgba(245,245,245,0.65);
      font-style: italic;
      font-size: 0.98rem;
      font-weight: 500;
    }

    .hintline {
      min-height: 1.2em;
      text-align: center;
      font-size: 0.9rem;
      font-weight: 800;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(245,245,245,0.78);
      user-select: none;
    }
    .hintline.hidden { display: none; }

    /* Score area */
    .score-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .score-fairies {
      text-align: center;
      font-size: 0.95rem;
      color: var(--fk-muted);
      letter-spacing: 0.04em;
    }
    .score-fairies strong { color: var(--fk-orange); font-weight: 900; }
    .score-value {
      font-size: 2.3rem;
      font-weight: 900;
      color: #ffffff;
      text-shadow: 0 0 14px rgba(0, 0, 0, 0.7);
      line-height: 1.0;
      letter-spacing: 0.02em;
    }

    /* API banner */
    .apikey-banner {
      position: fixed;
      top: 8px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      z-index: 50;
      pointer-events: none;
    }
    .apikey-inner {
      pointer-events: auto;
      background: rgba(15,15,15,0.92);
      border-radius: 999px;
      border: 1px solid var(--fk-border);
      padding: 6px 10px;
      display: flex;
      align-items: center;
      gap: 6px;
      max-width: 480px;
      width: calc(100% - 24px);
      box-shadow: 0 0 16px rgba(0, 0, 0, 0.8);
      font-size: 0.75rem;
      backdrop-filter: blur(6px);
    }
    .apikey-inner span { white-space: nowrap; }
    .apikey-input {
      flex: 1;
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid var(--fk-border);
      background: #111;
      color: #f5f5f5;
      font-size: 0.8rem;
      min-width: 0;
    }
    .apikey-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--fk-violet);
      background: var(--fk-violet);
      color: #fff;
      font-size: 0.75rem;
      cursor: pointer;
    }
    .apikey-btn:active { filter: brightness(0.9); }

    .hidden { display: none !important; }

    /* Setup overlay (Spieleranzahl) */
    .setup-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 80;
      padding: 18px;
      background: radial-gradient(circle at top, rgba(255,255,255,0.08) 0, rgba(0,0,0,0.90) 55%, rgba(0,0,0,0.96) 100%);
      backdrop-filter: blur(6px);
    }
    .setup-inner {
      width: 100%;
      max-width: 420px;
      text-align: center;
      padding: 10px 6px;
    }
    .setup-title {
      font-weight: 900;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 1.05rem;
      color: rgba(245,245,245,0.92);
      margin-bottom: 12px;
    }
    .setup-sub {
      font-size: 0.92rem;
      color: rgba(245,245,245,0.70);
      margin-bottom: 16px;
      line-height: 1.4;
    }
    .setup-choices {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin: 8px 0 14px;
    }
    .choice-circle {
      width: 78px;
      height: 78px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.22);
      background: radial-gradient(circle at top, rgba(255,255,255,0.08) 0, rgba(255,255,255,0.02) 55%, rgba(0,0,0,0) 100%);
      box-shadow: 0 0 18px rgba(0,0,0,0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(245,245,245,0.95);
      font-weight: 900;
      font-size: 1.5rem;
      letter-spacing: 0.04em;
      user-select: none;
      transition: transform 0.08s ease-out, filter 0.08s ease-out, border-color 0.12s ease-out;
      cursor: pointer;
    }
    .choice-circle:active { transform: translateY(1px) scale(0.99); filter: brightness(0.95); }
    .choice-circle.selected {
      border-color: rgba(242,150,0,0.75);
      box-shadow: 0 0 22px rgba(242,150,0,0.22), 0 0 18px rgba(0,0,0,0.55);
    }

    /* Award overlay (magisch, ohne Kasten) */
    .award-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 90;
      padding: 18px;
      background: rgba(0,0,0,0.92);
      overflow: hidden;
    }
    .stars {
      position: absolute;
      inset: -40px;
      background:
        radial-gradient(circle at 20% 30%, rgba(242,150,0,0.14), transparent 42%),
        radial-gradient(circle at 80% 25%, rgba(0,101,171,0.12), transparent 45%),
        radial-gradient(circle at 45% 80%, rgba(170,0,120,0.10), transparent 55%),
        radial-gradient(circle at 70% 75%, rgba(59,165,43,0.10), transparent 55%);
      filter: blur(10px);
      opacity: 0.95;
      animation: floaty 1.9s ease-in-out infinite alternate;
      pointer-events: none;
    }
    .twinkles {
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(circle, rgba(255,255,255,0.18) 0 1px, transparent 2px),
        radial-gradient(circle, rgba(255,255,255,0.12) 0 1px, transparent 2px),
        radial-gradient(circle, rgba(255,255,255,0.10) 0 1px, transparent 2px);
      background-size: 120px 120px, 160px 160px, 220px 220px;
      background-position: 0 0, 40px 80px, 90px 30px;
      opacity: 0.35;
      animation: drift 7s linear infinite;
      pointer-events: none;
    }
    @keyframes floaty { from { transform: translateY(0px) scale(1); } to { transform: translateY(-8px) scale(1.03); } }
    @keyframes drift { from { transform: translateY(0px); } to { transform: translateY(-120px); } }

    .award-inner {
      position: relative;
      z-index: 2;
      width: 100%;
      max-width: 460px;
      text-align: center;
      padding: 16px 10px 10px;
    }
    .award-title {
      font-weight: 900;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      font-size: 0.98rem;
      color: rgba(245,245,245,0.78);
      margin-bottom: 10px;
    }
    .award-lines {
      font-size: 1.12rem;
      line-height: 1.6;
      font-weight: 800;
      color: rgba(245,245,245,0.95);
      white-space: pre-line;
      margin-bottom: 12px;
      text-shadow: 0 0 18px rgba(0,0,0,0.65);
    }
    .award-points {
      font-size: clamp(2.4rem, 7vw, 3.1rem);
      font-weight: 900;
      letter-spacing: 0.10em;
      margin: 10px 0 16px;
      text-transform: uppercase;
      text-shadow: 0 0 22px rgba(0,0,0,0.65);
    }
    .award-points.good { color: var(--fk-green); }
    .award-points.ok { color: var(--fk-orange); }

    .award-actions {
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .btn-round {
      width: 74px;
      height: 74px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.20);
      background: rgba(255,255,255,0.04);
      color: rgba(245,245,245,0.92);
      font-weight: 900;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      box-shadow: 0 0 20px rgba(0,0,0,0.55);
    }
    .btn-round:active { transform: translateY(1px) scale(0.99); filter: brightness(0.95); }
    .btn-round.ok {
      border-color: rgba(59,165,43,0.55);
      box-shadow: 0 0 22px rgba(59,165,43,0.18), 0 0 20px rgba(0,0,0,0.55);
    }
    .btn-round.no {
      border-color: rgba(255,255,255,0.18);
    }

    /* Kipper-Position overlay */
    .pos-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 85;
      padding: 18px;
      background: radial-gradient(circle at top, rgba(255,255,255,0.08) 0, rgba(0,0,0,0.90) 55%, rgba(0,0,0,0.96) 100%);
      backdrop-filter: blur(6px);
    }
    .pos-inner {
      width: 100%;
      max-width: 460px;
      text-align: center;
      padding: 10px 6px;
    }
    .pos-title {
      font-weight: 900;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 0.98rem;
      color: rgba(245,245,245,0.92);
      margin-bottom: 14px;
      line-height: 1.35;
    }
    .pos-grid {
      display: grid;
      gap: 14px;
      width: 100%;
    }
    .pos-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.03);
      box-shadow: 0 0 18px rgba(0,0,0,0.40);
      cursor: pointer;
      user-select: none;
    }
    .pos-option:active { transform: translateY(1px) scale(0.995); filter: brightness(0.95); }

    .pos-left {
      display: flex;
      align-items: center;
      gap: 12px;
      text-align: left;
    }
    .pos-dot {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.03);
      box-shadow: 0 0 12px rgba(0,0,0,0.45);
      flex: 0 0 auto;
    }
    .pos-label {
      font-weight: 900;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: rgba(245,245,245,0.92);
      font-size: 1.02rem;
    }
    .pos-points {
      font-weight: 900;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(245,245,245,0.78);
      font-size: 0.95rem;
      white-space: nowrap;
    }

    /* tiny settings link */
    .top-tools {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
      z-index: 5;
    }
    .tool-btn {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.03);
      color: rgba(245,245,245,0.78);
      font-size: 0.72rem;
      font-weight: 800;
      letter-spacing: 0.10em;
      text-transform: uppercase;
    }
    .tool-btn:active { filter: brightness(0.9); }

    .microline {
      min-height: 0.6em;
      font-size: 0.75rem;
      color: transparent;
      text-align: center;
      user-select: none;
    }
  </style>
</head>

<body>
  <!-- API Key Banner -->
  <div class="apikey-banner" id="apikey-banner">
    <div class="apikey-inner">
      <span>OpenAI&nbsp;API-Key:</span>
      <input id="apikey-input" class="apikey-input" type="password" placeholder="sk-..." />
      <button class="apikey-btn" id="apikey-save-btn">OK</button>
    </div>
  </div>

  <div class="app">
    <div class="top-tools">
      <button class="tool-btn" id="players-btn">Spieler</button>
    </div>

    <header class="header">
      <div class="logo-line">
        <span class="logo-fairy">Fairy</span>
        <span class="logo-kipp">KIPP</span>
      </div>
      <div class="tagline">Unendlich viele KIPP-Geschichten</div>
    </header>

    <!-- Spielpanel -->
    <section class="panel">
      <div class="button-row">
        <button id="fairy-btn" class="btn-main">FAIRY</button>
      </div>
      <div class="microline">.</div>

      <div class="story-box" id="story-box">
        <div id="archive-target" class="archive-target"></div>
        <div id="story-text" class="story-muted">
          Tippe auf <strong>FAIRY</strong>, um eine neue Geschichte zu starten.
        </div>
      </div>

      <div id="hintline" class="hintline hidden">noch 1 kipp</div>
    </section>

    <!-- Punktepanel -->
    <section class="panel">
      <div class="score-row">
        <div class="score-fairies">
          Erzählte Fairys: <strong id="fairy-count">0</strong> / <span id="fairy-max">4</span>
        </div>
        <div class="score-value" id="score-value">0</div>
      </div>

      <div class="button-row" style="margin-top: 6px">
        <button id="erkippt-btn" class="btn-action" disabled>FAIRY ERKIPPT</button>
        <button id="niemand-btn" class="btn-action" disabled>NIEMAND HAT ES ERKIPPT</button>
      </div>

      <div class="button-row" style="margin-top: 6px">
        <button id="back-btn" class="btn-ghost">ZUR STARTSEITE</button>
      </div>
    </section>
  </div>

  <!-- Setup Overlay: Spieleranzahl -->
  <div class="setup-overlay" id="setup-overlay">
    <div class="setup-inner">
      <div class="setup-title">Wie viele Spieler seid ihr?</div>
      <div class="setup-sub">Tippe eine Zahl an. (2–4 Spieler)</div>
      <div class="setup-choices">
        <div class="choice-circle" data-n="2">2</div>
        <div class="choice-circle" data-n="3">3</div>
        <div class="choice-circle" data-n="4">4</div>
      </div>
    </div>
  </div>

  <!-- Kipper Position Overlay -->
  <div class="pos-overlay" id="pos-overlay">
    <div class="pos-inner">
      <div class="pos-title" id="pos-title">Warst du nach dem Fairy-Leser der … Kipper?</div>
      <div class="pos-grid" id="pos-grid"></div>
      <div style="margin-top:14px;">
        <button class="btn-ghost" id="pos-cancel">ABBRECHEN</button>
      </div>
    </div>
  </div>

  <!-- Award Overlay -->
  <div class="award-overlay" id="award-overlay">
    <div class="stars"></div>
    <div class="twinkles"></div>
    <div class="award-inner">
      <div class="award-title" id="award-title">FAIRY FUND</div>
      <div class="award-lines" id="award-lines"></div>
      <div class="award-points ok" id="award-points">+0</div>
      <div class="award-actions">
        <button class="btn-round ok" id="award-ok">OK</button>
        <button class="btn-round no" id="award-miss">NEIN</button>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // Konfiguration
    // -----------------------------
    const OPENAI_CHAT_URL = "https://api.openai.com/v1/chat/completions";
    const OPENAI_MODEL = "gpt-4o-mini";
    const APIKEY_STORAGE_KEY = "fairykipp_openai_key";

    // Spieler / Spielende
    const PLAYERS_STORAGE_KEY = "fairykipp_players";
    const MAX_FAIRIES = 4;

    // Punkte je Spieleranzahl (nach dem Fairy-Leser)
    // 2 Spieler: kein Prompt, immer 3
    // 3 Spieler: 1. Kipper = 5, 2. Kipper = 3
    // 4 Spieler: 1. Kipper = 8, 2. Kipper = 5, 3. Kipper = 3
    const POINTS_BY_PLAYERS = {
      2: [3],
      3: [5, 3],
      4: [8, 5, 3]
    };

    // Motive
    const motifsData = [
      { key: "Wasserball",  article: "der",  noun: "Wasserball"  },
      { key: "Auto",        article: "das",  noun: "Auto"        },
      { key: "Farbfleck",   article: "der",  noun: "Farbfleck"   },
      { key: "Buch",        article: "das",  noun: "Buch"        },
      { key: "Gießkanne",   article: "die",  noun: "Gießkanne"   },
      { key: "Kerze",       article: "die",  noun: "Kerze"       },
      { key: "Blume",       article: "die",  noun: "Blume"       },
      { key: "Fisch",       article: "der",  noun: "Fisch"       },
      { key: "Schmetterling", article: "der", noun: "Schmetterling" },
      { key: "Schuh",       article: "der",  noun: "Schuh"       },
      { key: "Tasse",       article: "die",  noun: "Tasse"       },
      { key: "T-Shirt",     article: "das",  noun: "T-Shirt"     }
    ];

    // Farb-Adjektive (nur diese!)
    const colorsData = ["grüne", "blaue", "violette", "orangefarbene"];

    // Lautverben je Motiv
    const motifVerbBase = {
      Wasserball: ["platschte","plumpste","spritzte","hüpfte","polterte","ploppte"],
      Auto: ["brummte","knatterte","röhrte","tuckerte","schnurrte","hupte","quietschte","dröhnte","heulte","fauchte"],
      Farbfleck: ["tropfte","kleckste","spritzte","schmierte","kleckerte","schmatzte"],
      Buch: ["raschelte","blätterte","murmelte","seufzte","flüsterte","knisterte","wisperte","brummte","klappte"],
      Gießkanne: ["plätscherte","tropfte","gluckerte","schwappte","gluckste","schwallte","gurgelte"],
      Kerze: ["flackerte","knisterte","zischte","glomm","flüsterte","seufzte","hauchte"],
      Blume: ["flüsterte","hauchte","seufzte","wisperte","raschelte","murmelte","säuselte","flötete"],
      Fisch: ["blubberte","gluckerte","sprudelte","murmelte","schmatzte","zischte","schlürfte","schwapperte","gluckste"],
      Schmetterling: ["flüsterte","wisperte","hauchte","seufzte","säuselte","murmelte","kicherte","trillierte","zirpte"],
      Schuh: ["quietschte","klackte","schlurfte","knirschte","tappte","stapfte","polterte","scharrte","knarzte"],
      Tasse: ["klirrte","klimperte","klackte","knackte","zitterte","murmelte","summte","brummte","seufzte"],
      "T-Shirt": ["raschelte","flatterte","seufzte","wisperte","knisterte","murmelte","hauchte","säuselte"]
    };

    // -----------------------------
    // UI-Elemente
    // -----------------------------
    const fairyBtn = document.getElementById("fairy-btn");
    const storyBox = document.getElementById("story-box");
    const archiveTargetEl = document.getElementById("archive-target");
    const storyTextEl = document.getElementById("story-text");
    const hintlineEl = document.getElementById("hintline");

    const scoreValueEl = document.getElementById("score-value");
    const fairyCountEl = document.getElementById("fairy-count");
    const fairyMaxEl = document.getElementById("fairy-max");

    const erkipptBtn = document.getElementById("erkippt-btn");
    const niemandBtn = document.getElementById("niemand-btn");

    const backBtn = document.getElementById("back-btn");
    const playersBtn = document.getElementById("players-btn");

    const apikeyBanner = document.getElementById("apikey-banner");
    const apikeyInput = document.getElementById("apikey-input");
    const apikeySaveBtn = document.getElementById("apikey-save-btn");

    const setupOverlay = document.getElementById("setup-overlay");
    const setupCircles = Array.from(document.querySelectorAll(".choice-circle"));

    const posOverlay = document.getElementById("pos-overlay");
    const posTitle = document.getElementById("pos-title");
    const posGrid = document.getElementById("pos-grid");
    const posCancel = document.getElementById("pos-cancel");

    const awardOverlay = document.getElementById("award-overlay");
    const awardTitle = document.getElementById("award-title");
    const awardLines = document.getElementById("award-lines");
    const awardPoints = document.getElementById("award-points");
    const awardOk = document.getElementById("award-ok");
    const awardMiss = document.getElementById("award-miss");

    // -----------------------------
    // Spielzustand
    // -----------------------------
    let apiKey = null;

    let playersCount = 4; // default, wird im Setup gewählt (2..4)

    let unusedMotifs = [];
    let unusedVerbsByMotif = {};

    let currentMotif = null;
    let currentVerb = null;
    let currentColor = null;

    let currentStoryFullPlain = "";
    let currentTailPlain = "";
    let currentTailHtml = "";
    let currentChunks = [];
    let currentChunkIndex = -1;

    let score = 0;
    let narratedFairies = 0;

    // Phasen:
    // idle: keine aktive Fairy (neue Fairy starten möglich)
    // reading: Zwölftel 1..11 (WEITER)
    // final: Zwölftel 12 (Pop kurz)
    // waiting: nach Pop -> Archiv oben, Spiel wartet auf Kipper/Leser Buttons
    let phase = "idle";

    // Pending award (Bestätigung)
    let pendingAward = null; // { points, kind: "kipper"|"reader" }

    // -----------------------------
    // Hilfsfunktionen
    // -----------------------------
    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function updateScoreDisplay() {
      scoreValueEl.textContent = String(score);
    }

    function updateFairyCountDisplay() {
      fairyCountEl.textContent = String(narratedFairies);
      fairyMaxEl.textContent = String(MAX_FAIRIES);
    }

    function initUnusedMotifs() {
      unusedMotifs = motifsData.slice();
    }

    function chooseMotifNoImmediateRepeat() {
      if (unusedMotifs.length === 0) initUnusedMotifs();
      const idx = Math.floor(Math.random() * unusedMotifs.length);
      const motif = unusedMotifs[idx];
      unusedMotifs.splice(idx, 1);
      return motif;
    }

    function getAllowedVerbsForMotif(noun) {
      const base = motifVerbBase[noun];
      return base ? base.slice() : [];
    }

    function initUnusedVerbsForMotif(noun) {
      const all = getAllowedVerbsForMotif(noun);
      unusedVerbsByMotif[noun] = shuffleArray(all);
    }

    function chooseVerbForMotif(noun) {
      if (!unusedVerbsByMotif[noun] || unusedVerbsByMotif[noun].length === 0) {
        initUnusedVerbsForMotif(noun);
      }
      return unusedVerbsByMotif[noun].pop();
    }

    function loadApiKeyFromStorage() {
      const stored = window.localStorage.getItem(APIKEY_STORAGE_KEY);
      if (stored && stored.startsWith("sk-")) {
        apiKey = stored;
        apikeyBanner.classList.add("hidden");
      } else {
        apiKey = null;
        apikeyBanner.classList.remove("hidden");
      }
    }

    function saveApiKeyToStorage(key) {
      apiKey = key;
      window.localStorage.setItem(APIKEY_STORAGE_KEY, key);
      apikeyBanner.classList.add("hidden");
    }

    function loadPlayersFromStorage() {
      const stored = window.localStorage.getItem(PLAYERS_STORAGE_KEY);
      const n = Number(stored);
      if (n === 2 || n === 3 || n === 4) playersCount = n;
    }

    function savePlayersToStorage(n) {
      playersCount = n;
      window.localStorage.setItem(PLAYERS_STORAGE_KEY, String(n));
    }

    function getCssColorForAdj(adj) {
      if (!adj) return null;
      const clean = adj.toLowerCase().replace(/[.,!?:;"“”„]+$/g, "");
      switch (clean) {
        case "blaue": return "var(--fk-blue)";
        case "grüne": return "var(--fk-green)";
        case "violette": return "var(--fk-violet)";
        case "orangefarbene": return "var(--fk-orange)";
        default: return null;
      }
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function highlightTailColor(tailPlain, adjective) {
      const cssColor = getCssColorForAdj(adjective);
      if (!cssColor) return escapeHtml(tailPlain);

      const escapedAdj = adjective.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      const regex = new RegExp(`\\b(${escapedAdj})\\b`, "i");
      const safe = escapeHtml(tailPlain);
      return safe.replace(regex, `<span style="color:${cssColor}">$1</span>`);
    }

    function splitWordsBalanced(text, n) {
      const words = text.trim().split(/\s+/).filter(Boolean);
      if (words.length === 0) return Array.from({ length: n }, () => "");

      const totalLen = words.reduce((acc, w) => acc + w.length + 1, 0);
      const target = Math.max(1, Math.round(totalLen / n));

      const chunks = [];
      let cur = [];
      let curLen = 0;

      for (const w of words) {
        const addLen = w.length + (cur.length ? 1 : 0);

        if (chunks.length < n - 1 && cur.length > 0 && (curLen + addLen) > target) {
          chunks.push(cur.join(" "));
          cur = [w];
          curLen = w.length;
        } else {
          cur.push(w);
          curLen += addLen;
        }
      }

      chunks.push(cur.join(" "));

      while (chunks.length < n) chunks.push("");
      while (chunks.length > n) {
        const a = chunks.pop();
        chunks[chunks.length - 1] = (chunks[chunks.length - 1] + " " + a).trim();
      }

      return chunks;
    }

    function buildTwelfthsVisually(fullPlain, tailPlain, colorAdj) {
      let head = fullPlain.trim();
      const tail = tailPlain.trim();

      if (head.endsWith(tail)) {
        head = head.slice(0, head.length - tail.length).trim();
      } else {
        const idx = head.lastIndexOf(tail);
        if (idx !== -1) head = head.slice(0, idx).trim();
      }

      const first11 = splitWordsBalanced(head, 11);
      const tailHtml = highlightTailColor(tailPlain, colorAdj);
      return [...first11, tailHtml];
    }

    function setHint(text) {
      if (!text) {
        hintlineEl.classList.add("hidden");
        hintlineEl.textContent = "";
        return;
      }
      hintlineEl.textContent = text;
      hintlineEl.classList.remove("hidden");
    }

    function setArchiveTarget(htmlOrEmpty) {
      if (!htmlOrEmpty) {
        archiveTargetEl.innerHTML = "";
        archiveTargetEl.classList.remove("show");
        return;
      }
      archiveTargetEl.innerHTML = htmlOrEmpty;
      archiveTargetEl.classList.add("show");
    }

    function setStoryMuted(html) {
      storyTextEl.classList.add("story-muted");
      storyTextEl.innerHTML = html;
    }

    function setStoryPlain(text) {
      storyTextEl.classList.remove("story-muted");
      storyTextEl.textContent = text;
    }

    function setStoryHtml(html) {
      storyTextEl.classList.remove("story-muted");
      storyTextEl.innerHTML = html;
    }

    function setFairyButton(mode) {
      // mode: "FAIRY" | "WEITER" | "HIDE"
      if (mode === "HIDE") {
        fairyBtn.classList.add("hidden");
        return;
      }
      fairyBtn.classList.remove("hidden");
      fairyBtn.textContent = mode;
    }

    function setActionButtonsEnabled() {
      const enable = (phase === "waiting");
      erkipptBtn.disabled = !enable;
      niemandBtn.disabled = !enable;
    }

    function resetRoundToIdle() {
      currentMotif = null;
      currentVerb = null;
      currentColor = null;

      currentStoryFullPlain = "";
      currentTailPlain = "";
      currentTailHtml = "";
      currentChunks = [];
      currentChunkIndex = -1;

      setArchiveTarget("");
      setHint("");
      setFairyButton("FAIRY");

      phase = "idle";

      setActionButtonsEnabled();
      if (narratedFairies >= MAX_FAIRIES) {
        setStoryMuted("Spielende. Es wurden 4 FAIRYs abgeschlossen.");
        setFairyButton("HIDE");
        return;
      }

      setStoryMuted(`Tippe auf <strong>FAIRY</strong>, um eine neue Geschichte zu starten.`);
    }

    // -----------------------------
    // Sound (kurz, ohne externe Files)
    // -----------------------------
    function beep(freq = 880, duration = 0.12, gain = 0.06) {
      try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioCtx();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = freq;
        g.gain.value = gain;
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        setTimeout(() => {
          o.stop();
          ctx.close();
        }, Math.max(30, duration * 1000));
      } catch (_) {}
    }
    function playReaderSound() {
      beep(660, 0.10, 0.05);
      setTimeout(() => beep(880, 0.10, 0.05), 120);
    }
    function playKipperSound() {
      beep(880, 0.10, 0.06);
      setTimeout(() => beep(990, 0.10, 0.06), 120);
      setTimeout(() => beep(1320, 0.12, 0.07), 260);
    }

    // -----------------------------
    // Setup Overlay (immer verfügbar)
    // -----------------------------
    function showSetupOverlay(always = true) {
      // always=true: Setup wird IMMER gezeigt (dein Wunsch: bei jedem Eintritt ins Spiel)
      // Wir laden gespeicherte Wahl nur als "vorselektiert".
      loadPlayersFromStorage();

      setupCircles.forEach(c => c.classList.remove("selected"));
      const pre = setupCircles.find(c => Number(c.dataset.n) === playersCount);
      if (pre) pre.classList.add("selected");

      setupOverlay.style.display = "flex";

      // Wenn das Setup offen ist: keine Fehlklicks im Spiel
      posOverlay.style.display = "none";
      awardOverlay.style.display = "none";
    }

    function closeSetupOverlay() {
      setupOverlay.style.display = "none";
    }

    // -----------------------------
    // Award Overlay
    // -----------------------------
    function openAwardOverlay(kind, points) {
      pendingAward = { kind, points };

      awardTitle.textContent = "FAIRY FUND";

      if (kind === "reader") {
        awardLines.textContent = "Niemand hat’s erkippt.\nLesebonus:";
        awardPoints.classList.remove("good");
        awardPoints.classList.add("ok");
        awardPoints.textContent = `+${points}`;
        playReaderSound();
      } else {
        awardLines.textContent = "Erkippt.";
        awardPoints.classList.remove("ok");
        awardPoints.classList.add("good");
        awardPoints.textContent = `+${points}`;
        playKipperSound();
      }

      awardOverlay.style.display = "flex";
    }

    function closeAwardOverlay() {
      awardOverlay.style.display = "none";
      pendingAward = null;
    }

    function confirmAward() {
      if (!pendingAward) return;

      score += pendingAward.points;
      updateScoreDisplay();

      narratedFairies += 1;
      if (narratedFairies > MAX_FAIRIES) narratedFairies = MAX_FAIRIES;
      updateFairyCountDisplay();

      closeAwardOverlay();

      // Nach jeder Wertung: neue Runde oder Spielende
      resetRoundToIdle();
    }

    // -----------------------------
    // Kipper-Position Overlay
    // -----------------------------
    function openPositionOverlay() {
      const pts = POINTS_BY_PLAYERS[playersCount] || POINTS_BY_PLAYERS[4];

      // 2 Spieler -> kein Prompt, direkt 3 Punkte
      if (playersCount === 2) {
        openAwardOverlay("kipper", pts[0]);
        return;
      }

      // 3 Spieler -> 2 Optionen; 4 Spieler -> 3 Optionen
      posGrid.innerHTML = "";
      posTitle.textContent = "Warst du nach dem Fairy-Leser der … Kipper?";

      pts.forEach((p, idx) => {
        const which = idx + 1; // 1,2,3
        const opt = document.createElement("div");
        opt.className = "pos-option";
        opt.innerHTML = `
          <div class="pos-left">
            <div class="pos-dot"></div>
            <div class="pos-label">${which}. KIPPER</div>
          </div>
          <div class="pos-points">${p} PUNKTE</div>
        `;
        opt.addEventListener("click", () => {
          posOverlay.style.display = "none";
          openAwardOverlay("kipper", p);
        });
        posGrid.appendChild(opt);
      });

      posOverlay.style.display = "flex";
    }

    // -----------------------------
    // OpenAI: neue Fairy
    // -----------------------------
    async function generateNewFairyAndShowFirstTwelfth(retryCount = 0) {
      if (narratedFairies >= MAX_FAIRIES) {
        resetRoundToIdle();
        return;
      }

      if (!apiKey) {
        apikeyBanner.classList.remove("hidden");
        return;
      }

      setFairyButton("HIDE");
      setHint("");
      setArchiveTarget("");
      setStoryMuted("… KI zaubert eine neue Geschichte …");

      const motifObj = chooseMotifNoImmediateRepeat();
      const verb = chooseVerbForMotif(motifObj.noun);
      const color = colorsData[Math.floor(Math.random() * colorsData.length)];

      currentMotif = motifObj;
      currentVerb = verb;
      currentColor = color;

      const systemMessage = {
        role: "system",
        content:
          "Du schreibst sehr kurze Fabeltexte auf Deutsch für ein Gesellschaftsspiel.\n" +
          "Du MUSST GENAU zwei Sätze liefern, insgesamt etwa 18–28 Wörter.\n" +
          "Regeln:\n" +
          "- Schreibe in der dritten Person.\n" +
          "- Verwende keine weiteren Farbwörter im Text.\n" +
          "- Verwende das Motivwort NICHT.\n" +
          "- Kein Genitiv.\n" +
          "- Kein 'sagte', 'meinte', 'dachte'.\n"
      };

      const userMessage = {
        role: "user",
        content:
          "Die unsichtbare Hauptfigur dieser Fabel ist: \"" + motifObj.noun + "\".\n" +
          "Schreibe GENAU zwei zusammenhängende Sätze, insgesamt ca. 18–28 Wörter.\n" +
          "Der erste Satz beschreibt die Situation, ohne das Wort \"" + motifObj.noun + "\".\n" +
          "Der zweite Satz besteht nur aus wörtlicher Rede und endet mit einem abschließenden Anführungszeichen und einem Satzzeichen (. ? oder !).\n" +
          "Nach dem zweiten Satz darf in deiner Antwort nichts Inhaltliches mehr folgen.\n"
      };

      try {
        const response = await fetch(OPENAI_CHAT_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + apiKey
          },
          body: JSON.stringify({
            model: OPENAI_MODEL,
            messages: [systemMessage, userMessage],
            temperature: 0.8,
            max_tokens: 220
          })
        });

        if (!response.ok) throw new Error("HTTP-Fehler: " + response.status);

        const data = await response.json();
        let text = data.choices?.[0]?.message?.content?.trim() || "";
        text = text.replace(/\s+/g, " ").trim();

        const dotIdx = text.lastIndexOf(".");
        const exIdx = text.lastIndexOf("!");
        const qIdx = text.lastIndexOf("?");
        const lastPunctIdx = Math.max(dotIdx, exIdx, qIdx);

        if (lastPunctIdx === -1) {
          if (retryCount < 3) return await generateNewFairyAndShowFirstTwelfth(retryCount + 1);

          const base = 'Etwas Unbenanntes wartete geduldig am Rand des Spielfelds. "Jetzt kommt mein Moment!"';
          const tailPlain = `${motifObj.article} ${color} ${motifObj.noun}`;
          const storyPlain = `${base} ${verb} ${tailPlain}`.replace(/\s+/g, " ").trim();

          currentStoryFullPlain = storyPlain;
          currentTailPlain = tailPlain;
          currentTailHtml = highlightTailColor(currentTailPlain, color);

          currentChunks = buildTwelfthsVisually(currentStoryFullPlain, currentTailPlain, color);
        } else {
          const baseText = text.slice(0, lastPunctIdx + 1).trimRight();
          const tailPlain = `${motifObj.article} ${color} ${motifObj.noun}`;
          const storyPlain = `${baseText} ${verb} ${tailPlain}`.replace(/\s+/g, " ").trim();

          currentStoryFullPlain = storyPlain;
          currentTailPlain = tailPlain;
          currentTailHtml = highlightTailColor(currentTailPlain, color);

          currentChunks = buildTwelfthsVisually(currentStoryFullPlain, currentTailPlain, color);
        }

        currentChunkIndex = 0;
        phase = "reading";
        setActionButtonsEnabled();

        setFairyButton("WEITER");
        setStoryPlain(currentChunks[0] || "");
      } catch (err) {
        console.error(err);
        setFairyButton("FAIRY");
        setStoryMuted("Die Fairy hat sich im Nebel verirrt. Prüfe bitte Internet und API-Key.");
        phase = "idle";
        setActionButtonsEnabled();
      }
    }

    function showNextChunkOrFinal() {
      if (!currentChunks || currentChunks.length !== 12) return;

      if (phase !== "reading") return;

      const next = currentChunkIndex + 1;

      if (next <= 10) { // 2..11
        currentChunkIndex = next;
        setStoryPlain(currentChunks[currentChunkIndex] || "");
        return;
      }

      // Zwölftel 12 kurz groß
      currentChunkIndex = 11;
      phase = "final";
      setActionButtonsEnabled();

      setFairyButton("HIDE");
      setHint("noch 1 kipp");
      setArchiveTarget("");

      setStoryHtml(
        `<div style="
          font-size: clamp(1.9rem, 7vw, 2.45rem);
          font-weight: 900;
          letter-spacing: 0.10em;
          text-transform: uppercase;
          line-height: 1.15;
          padding: 10px 0 8px;
          text-shadow: 0 0 18px rgba(0,0,0,0.65);">
          ${currentTailHtml}
        </div>`
      );

      // Danach: Archiv oben, warten auf Kipper/Leser
      setTimeout(() => {
        setArchiveTarget(currentTailHtml);
        setStoryMuted(" ");
        setHint("");

        phase = "waiting";
        setActionButtonsEnabled();

        // FAIRY bleibt absichtlich wieder da, aber macht in waiting nichts
        setFairyButton("FAIRY");
      }, 2900);
    }

    // -----------------------------
    // Buttons: "Fairy erkippt" / "Niemand hat es erkippt"
    // -----------------------------
    function onErkippt() {
      if (phase !== "waiting") return;
      // Position abfragen (oder bei 2 Spielern direkt vergeben)
      openPositionOverlay();
    }

    function onNiemand() {
      if (phase !== "waiting") return;
      openAwardOverlay("reader", 1);
    }

    // -----------------------------
    // Event-Listener
    // -----------------------------
    fairyBtn.addEventListener("click", async () => {
      if (phase === "idle") {
        await generateNewFairyAndShowFirstTwelfth();
        return;
      }

      if (phase === "reading") {
        showNextChunkOrFinal();
        return;
      }

      // phase "waiting": FAIRY macht absichtlich nichts (damit niemand weiterklickt)
    });

    erkipptBtn.addEventListener("click", onErkippt);
    niemandBtn.addEventListener("click", onNiemand);

    awardOk.addEventListener("click", () => confirmAward());
    awardMiss.addEventListener("click", () => closeAwardOverlay());

    posCancel.addEventListener("click", () => { posOverlay.style.display = "none"; });

    backBtn.addEventListener("click", () => {
      window.location.href = "index.html";
    });

    playersBtn.addEventListener("click", () => {
      // jederzeit Spieleranzahl ändern
      showSetupOverlay(true);
    });

    apikeySaveBtn.addEventListener("click", () => {
      const val = apikeyInput.value.trim();
      if (!val || !val.startsWith("sk-")) {
        alert("Bitte einen gültigen OpenAI-API-Key eingeben (beginnt mit 'sk-').");
        return;
      }
      saveApiKeyToStorage(val);
    });

    apikeyInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") apikeySaveBtn.click();
    });

    // Setup Auswahl
    setupCircles.forEach(circle => {
      circle.addEventListener("click", () => {
        const n = Number(circle.dataset.n);
        if (!(n === 2 || n === 3 || n === 4)) return;

        setupCircles.forEach(c => c.classList.remove("selected"));
        circle.classList.add("selected");

        savePlayersToStorage(n);
        closeSetupOverlay();

        // Bei Spielerwechsel: Runde sauber zurücksetzen
        resetRoundToIdle();
      });
    });

    // -----------------------------
    // Start
    // -----------------------------
    function init() {
      loadApiKeyFromStorage();
      initUnusedMotifs();

      score = 0;
      narratedFairies = 0;
      updateScoreDisplay();
      updateFairyCountDisplay();

      // Startzustand
      resetRoundToIdle();

      // WICHTIG: Setup kommt IMMER beim Start dieser Seite
      // (damit es nie „verschwindet“, egal was Browser speichert)
      showSetupOverlay(true);
    }

    init();
  </script>
</body>
</html>
