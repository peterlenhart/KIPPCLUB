<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>KIPP CLUB ‚Äì SMILEY & FAIRY</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Fonts f√ºr FAIRY -->
  <link
    href="https://fonts.googleapis.com/css2?family=Pacifico&family=Montserrat:wght@500;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      /* FAIRY-Farben */
      --fk-blue: rgb(0, 101, 171);
      --fk-violet: rgb(170, 0, 120);
      --fk-green: rgb(59, 165, 43);
      --fk-orange: rgb(242, 150, 0);
      --fk-bg: #111111;
      --fk-panel: #1b1b1b;
      --fk-text: #f5f5f5;
      --fk-muted: #bbbbbb;
      --fk-border: #333333;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", Arial, sans-serif;
      background: radial-gradient(circle at top, #222 0, #000 55%, #000 100%);
      color: #f5f5f5;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 12px;
    }

    /* KIPP-CLUB Rahmen */
    .club-shell {
      width: 100%;
      max-width: 540px;
    }

    .club-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin-bottom: 10px;
      text-align: center;
    }

    .club-title {
      font-size: 1.4rem;
      font-weight: 800;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #e5ff4a;
      text-shadow: 0 0 10px rgba(0,0,0,0.6);
    }

    .club-subtitle {
      font-size: 0.9rem;
      color: #cbd5f5;
    }

    .club-mode-toggle {
      margin-top: 6px;
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      overflow: hidden;
      background: #020617;
    }

    .club-mode-btn {
      padding: 6px 12px;
      font-size: 0.85rem;
      font-weight: 700;
      border: none;
      cursor: pointer;
      background: transparent;
      color: #e5e7eb;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      min-width: 90px;
    }

    .club-mode-btn.active {
      background: #22c55e;
      color: #022c22;
    }

    /* ===========================
       FAIRY-KIPP STYLES (unver√§ndert in der Logik)
       =========================== */

    .app {
      width: 100%;
      max-width: 480px;
      background: var(--fk-bg);
      border-radius: 18px;
      border: 1px solid var(--fk-border);
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
      padding: 14px 14px 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 4px;
    }

    .logo-line {
      display: inline-flex;
      align-items: baseline;
      gap: 6px;
    }

    .logo-fairy {
      font-family: "Pacifico", cursive;
      font-size: 1.8rem;
      letter-spacing: 0.05em;
      color: var(--fk-orange);
      text-shadow: 0 0 6px rgba(242, 150, 0, 0.8);
    }

    .logo-kipp {
      font-family: "Montserrat", sans-serif;
      font-weight: 700;
      font-size: 1.4rem;
      letter-spacing: 0.2em;
      color: var(--fk-blue);
      text-transform: uppercase;
    }

    .tagline {
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--fk-muted);
    }

    .panel {
      background: var(--fk-panel);
      border-radius: 14px;
      border: 1px solid var(--fk-border);
      padding: 10px 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--fk-muted);
    }

    .pill {
      border-radius: 999px;
      padding: 3px 9px;
      border: 1px solid var(--fk-border);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .pill-blue {
      border-color: var(--fk-blue);
      color: var(--fk-blue);
    }

    .pill-violet {
      border-color: var(--fk-violet);
      color: var(--fk-violet);
    }

    .button-row {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    button { border: none; cursor: pointer; font-family: inherit; }

    .btn-main {
      min-width: 160px;
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background-color: var(--fk-orange);
      color: #111;
      box-shadow: 0 0 12px rgba(242, 150, 0, 0.7);
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out,
        filter 0.08s ease-out;
    }

    .btn-main:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 0 3px rgba(242, 150, 0, 0.6);
      filter: brightness(0.95);
    }

    .btn-secondary {
      min-width: 140px;
      padding: 9px 16px;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background-color: var(--fk-blue);
      color: #fdfdfd;
      box-shadow: 0 0 12px rgba(0, 101, 171, 0.5);
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out,
        filter 0.08s ease-out;
    }

    .btn-secondary:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 0 3px rgba(0, 101, 171, 0.6);
      filter: brightness(0.95);
    }

    .btn-ghost {
      align-self: center;
      margin-top: 4px;
      padding: 5px 8px;
      border-radius: 8px;
      font-size: 0.75rem;
      border: 1px solid transparent;
      background: transparent;
      color: var(--fk-violet);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .btn-ghost:active {
      border-color: var(--fk-violet);
      background: rgba(170, 0, 120, 0.1);
    }

    .btn-small {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      border: 1px solid var(--fk-violet);
      background: transparent;
      color: var(--fk-violet);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .btn-small:active {
      background: rgba(170, 0, 120, 0.1);
    }

    .story-box {
      min-height: 130px;
      max-height: 210px;
      border-radius: 10px;
      border: 1px solid var(--fk-border);
      padding: 10px 11px;
      font-size: 1.05rem;
      line-height: 1.55;
      background: radial-gradient(circle at top left, #252525 0, #111 55%);
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      overflow-y: auto;
    }

    .story-muted {
      color: var(--fk-muted);
      font-style: italic;
      font-size: 0.95rem;
    }

    .story-footer {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      color: var(--fk-muted);
      margin-top: 4px;
    }

    .sentence-indicator {
      color: var(--fk-violet);
    }

    .motif-big {
      width: 100%;
      text-align: center;
      font-size: clamp(1.6rem, 9vw, 2.3rem);
      font-weight: 800;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-top: 4px;
      line-height: 1.1;
      white-space: nowrap;
    }

    .score-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .score-main {
      flex: 2;
      text-align: center;
    }

    .score-label {
      font-size: 0.75rem;
      color: var(--fk-muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 2px;
    }

    .score-value {
      font-size: 2.1rem;
      font-weight: 700;
      color: #ffffff;
      text-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
    }

    .score-fairies {
      flex: 1.4;
      text-align: right;
      font-size: 0.8rem;
      color: var(--fk-muted);
    }

    .score-fairies strong {
      color: var(--fk-orange);
      font-weight: 700;
    }

    .end-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.88);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .end-card {
      width: 90%;
      max-width: 420px;
      background: #111;
      border-radius: 18px;
      border: 1px solid var(--fk-border);
      padding: 18px 16px 16px;
      text-align: center;
      box-shadow: 0 0 24px rgba(0, 0, 0, 0.9);
    }

    .end-title {
      font-family: "Pacifico", cursive;
      font-size: 1.7rem;
      color: var(--fk-orange);
      text-shadow: 0 0 10px rgba(242, 150, 0, 0.8);
      margin-bottom: 6px;
    }

    .end-score-label {
      font-size: 0.9rem;
      color: var(--fk-muted);
      margin-top: 8px;
    }

    .end-score-value {
      font-size: 2.4rem;
      font-weight: 700;
      color: var(--fk-green);
      margin: 2px 0 10px;
    }

    .end-sub {
      font-size: 0.85rem;
      color: var(--fk-muted);
      margin-bottom: 10px;
    }

    .apikey-banner {
      position: fixed;
      top: 8px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      z-index: 50;
      pointer-events: none;
    }

    .apikey-inner {
      pointer-events: auto;
      background: #151515;
      border-radius: 999px;
      border: 1px solid var(--fk-border);
      padding: 6px 10px;
      display: flex;
      align-items: center;
      gap: 6px;
      max-width: 480px;
      width: calc(100% - 24px);
      box-shadow: 0 0 14px rgba(0, 0, 0, 0.7);
      font-size: 0.75rem;
    }

    .apikey-inner span { white-space: nowrap; }

    .apikey-input {
      flex: 1;
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid var(--fk-border);
      background: #111;
      color: #f5f5f5;
      font-size: 0.8rem;
      min-width: 0;
    }

    .apikey-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--fk-violet);
      background: var(--fk-violet);
      color: #fff;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .apikey-btn:active { filter: brightness(0.9); }

    .hidden { display: none !important; }

    .status-line {
      font-size: 0.75rem;
      color: var(--fk-muted);
      min-height: 1em;
      margin-top: 2px;
      text-align: center;
    }

    .status-error { color: #ff6b81; }

    /* ===========================
       KIPP SMILEY STYLES (leicht umbenannt: .app-smiley)
       =========================== */

    .app-smiley {
      width: 100%;
      max-width: 480px;
      text-align: center;
      position: relative;
      margin: 0 auto;
    }

    .hamburger {
      position: absolute;
      top: 14px;
      right: 16px;
      font-size: 2rem;
      cursor: pointer;
      user-select: none;
      z-index: 30;
    }

    .info-icon {
      position: absolute;
      top: 62px;
      right: 22px;
      font-size: 1.7rem;
      cursor: pointer;
      z-index: 25;
      opacity: 0.9;
      user-select: none;
    }

    .info-icon:hover { opacity: 1; }

    .info-icon.show-close::after {
      content: "‚úñ";
      position: absolute;
      top: -6px;
      right: -6px;
      font-size: 1.4rem;
      color: #ff3333;
      text-shadow: 0 0 4px #000;
      pointer-events: none;
    }

    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 20;
      color: #fff;
      font-size: 1.4rem;
      padding: 20px;
      text-align: center;
    }

    h1 {
      margin: 0 0 20px;
      font-size: 1.9rem;
      letter-spacing: 0.05em;
      font-weight: 800;
    }

    .card-wrapper {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    .card {
      width: min(90vw, 360px);
      height: min(90vw, 360px);
      max-width: 380px;
      max-height: 380px;
      background: linear-gradient(145deg, #1f2838, #151b28);
      border-radius: 28px;
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      position: relative;
    }

    .card-inner {
      width: 92%;
      height: 82%;
      background: #0f172a;
      border-radius: 22px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 10px;
      text-align: center;
      overflow: hidden;
      position: relative;
    }

    .combo-row {
      display: none;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 26px;
    }

    .smiley-face {
      font-size: 5.2rem;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.6));
      cursor: pointer;
    }

    .smiley-hand {
      font-size: 4.2rem;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.6));
      cursor: pointer;
    }

    .smiley-face.selected,
    .smiley-hand.selected {
      outline: 3px solid #facc15;
      border-radius: 999px;
      transition: outline-color 0.6s ease;
    }

    .smiley-face.selected.fade-out,
    .smiley-hand.selected.fade-out {
      outline-color: transparent;
    }

    .card-message {
      font-size: 1.25rem;
      font-weight: 700;
      opacity: 0.95;
      color: #f8fafc;
      line-height: 1.35;
      padding: 0 6px;
    }

    .points-popup {
      min-height: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.6s ease;
      pointer-events: none;
    }

    .points-popup.visible { opacity: 1; }

    .points-number {
      font-size: 2.5rem;
      font-weight: 900;
      color: #ffc93b;
      line-height: 1;
    }

    .points-label {
      font-size: 1rem;
      color: #f9fafb;
      margin-top: 2px;
    }

    .points-sub {
      font-size: 1.15rem;
      font-weight: 700;
      color: #e5e7eb;
      margin-top: 4px;
    }

    .points-popup.setze-aus {
      position: absolute;
      inset: 0;
      background: #0b1220;
      border-radius: 22px;
      min-height: 0;
      padding: 10px;
    }

    .points-popup.setze-aus .points-number { font-size: 3.2rem; }
    .points-popup.setze-aus .points-label { font-size: 1.1rem; margin-top: 6px; }
    .points-popup.setze-aus .points-sub { font-size: 1.6rem; margin-top: 10px; }

    .rules-container {
      display: none;
      width: 100%;
      height: 100%;
      overflow-y: auto;
      text-align: left;
      padding: 8px 10px 4px;
      font-size: 0.92rem;
      line-height: 1.45;
    }

    .rules-text h2 {
      font-size: 1.15rem;
      margin: 0 0 6px;
      font-weight: 800;
      color: #ffc93b;
    }

    .rules-text h3 {
      font-size: 1.0rem;
      margin: 10px 0 4px;
      font-weight: 700;
      color: #ffc93b;
    }

    .rules-text p { margin: 4px 0; }

    .rules-text p.bullet {
      padding-left: 1.4em;
      text-indent: -1.4em;
    }

    .rules-text p.points-heading { margin: 18px 0 10px 0; }

    .rules-separator {
      margin: 8px 0;
      border-top: 1px solid rgba(148,163,184,0.4);
    }

    .rules-text img {
      width: 100%;
      max-width: 100%;
      border-radius: 10px;
      margin: 6px 0 10px;
      display: block;
    }

    .buttons-row {
      display: grid;
      grid-template-columns: 0.45fr 0.10fr 0.45fr;
      gap: 10px;
      margin-bottom: 18px;
      align-items: stretch;
    }

    .btn {
      border: none;
      border-radius: 20px;
      padding: 14px 10px;
      font-size: 1.1rem;
      font-weight: 800;
      cursor: pointer;
    }

    .btn-primary { background: #10b981; color: #022c22; }
    .btn-secondary { background: #f59e0b; color: #451a03; }

    .btn-undo {
      background: #1e293b;
      color: #e5e7eb;
      font-size: 1.4rem;
      padding: 10px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: 3px solid #4b5563;
    }

    .btn-undo.btn-undo-disabled {
      opacity: 0.35;
      cursor: default;
    }

    .score-area {
      margin-top: 6px;
      padding: 20px 14px 22px;
      background: #0b1220;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.3);
      text-align: center;
    }

    .score-big {
      font-size: 3.4rem;
      font-weight: 900;
      color: #e5ff4a;
      margin-bottom: 6px;
    }

    .moves-display {
      margin-top: 4px;
      font-size: 0.95rem;
      color: #cbd5f5;
    }

    .start-row {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .start-btn {
      flex: 1;
      border-radius: 16px;
      padding: 10px 6px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      border: 2px solid transparent;
    }

    .start-btn-start {
      background: #22c55e;
      color: #022c22;
      border-color: #16a34a;
    }

    .start-btn-start.reset-mode {
      background: transparent;
      color: #22c55e;
      border-color: #16a34a;
    }

    .start-btn-close { background: #ef4444; color: white; }

    .reset-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 40;
    }

    .reset-dialog {
      background: #0f172a;
      border-radius: 20px;
      padding: 18px 18px 16px;
      width: min(80vw, 320px);
      border: 1px solid rgba(148,163,184,0.6);
      text-align: center;
    }

    .reset-title {
      margin: 0 0 6px;
      font-size: 1.2rem;
      font-weight: 800;
    }

    .reset-text {
      margin: 0 0 14px;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .reset-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .reset-btn {
      flex: 1;
      border-radius: 14px;
      padding: 9px 6px;
      font-size: 0.95rem;
      font-weight: 700;
      border: none;
      cursor: pointer;
    }

    .reset-btn.cancel {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }

    .reset-btn.confirm {
      background: #f97316;
      color: #451a03;
    }

    .menu-box {
      background: #0f172a;
      padding: 22px 18px;
      border-radius: 18px;
      width: min(85vw, 340px);
      text-align: left;
      border: 1px solid rgba(255,255,255,0.12);
    }

    .menu-title {
      margin: 0 0 14px;
      font-size: 1.2rem;
      font-weight: 800;
      text-align: left;
    }

    .menu-item {
      width: 100%;
      background: #1e293b;
      color: #f1f5f9;
      border: none;
      padding: 12px 10px;
      margin-bottom: 12px;
      border-radius: 10px;
      font-size: 0.98rem;
      text-align: left;
      cursor: pointer;
    }

    .menu-item:hover { background: #334155; }

    .menu-close-btn {
      width: 100%;
      background: #ef4444;
      color: white;
      border: none;
      padding: 12px 10px;
      border-radius: 10px;
      font-size: 1rem;
      margin-top: 6px;
      cursor: pointer;
    }

    .menu-close-btn:hover { background: #dc2626; }

    .hand-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 35;
    }

    .hand-dialog {
      background: #0f172a;
      border-radius: 24px;
      padding: 18px;
      width: min(90vw, 360px);
      border: 1px solid rgba(148,163,184,0.7);
      position: relative;
    }

    .hand-dialog::before {
      content: "";
      display: block;
      width: 46px;
      height: 4px;
      background: #4b5563;
      border-radius: 999px;
      margin: 0 auto 10px;
      opacity: 0.9;
    }

    .hand-dialog-title {
      margin: 0 0 10px;
      font-size: 1.15rem;
      font-weight: 800;
      text-align: center;
    }

    .hand-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 12px;
    }

    .hand-option {
      background: #111827;
      border-radius: 16px;
      border: 2px solid transparent;
      padding: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .hand-option .hand-symbol {
      font-size: 2.6rem;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.6));
      display: inline-block;
    }

    .hand-option.active {
      border-color: #22c55e;
      background: #022c22;
    }

    .hand-buttons {
      display: flex;
      gap: 10px;
    }

    .hand-buttons button {
      flex: 1;
      border-radius: 14px;
      padding: 10px 6px;
      font-size: 0.95rem;
      font-weight: 700;
      border: none;
      cursor: pointer;
    }

    .hand-confirm { background: #22c55e; color: #022c22; }
    .hand-reset   { background: #111827; color: #e5e7eb; border: 1px solid #4b5563; }

    .luck-title {
      font-size: 1.3rem;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .luck-text { font-size: 0.95rem; }

    .luck-text .luck-number {
      font-size: 1.6rem;
      font-weight: 900;
      color: #ffc93b;
      margin: 0 2px;
    }

    .kippstopp-title {
      font-size: 2rem;
      font-weight: 900;
      color: #e5ff4a;
      margin-top: 6px;
    }
  </style>
</head>

<body>

<div class="club-shell">
  <header class="club-header">
    <div class="club-title">KIPP CLUB</div>
    <div class="club-subtitle">KIPP SMILEY &amp; KIPP FAIRY in einer App</div>
    <div class="club-mode-toggle">
      <button id="modeSmiley" class="club-mode-btn active">SMILEY</button>
      <button id="modeFairy" class="club-mode-btn">FAIRY</button>
    </div>
  </header>

  <!-- =======================
       KIPP SMILEY APP
       ======================= -->
  <div id="smiley-app" class="app-smiley">

    <div class="hamburger" id="menuBtn">‚ò∞</div>
    <div class="info-icon" id="infoIcon">üìô</div>

    <div class="menu-overlay" id="menuOverlay">
      <div class="menu-box">
        <h3 class="menu-title">Men√º</h3>

        <button onclick="openRulesScroll()" class="menu-item">
          üìô Scrollbare Spielanleitung
        </button>

        <button onclick="openRulesPdf()" class="menu-item">
          ‚¨áÔ∏è PDF herunterladen
        </button>

        <button onclick="window.location.href='mailto:office@p-lenhart.at'" class="menu-item">
          Kontakt: Peter Lenhart
        </button>

        <button class="menu-close-btn" onclick="closeMenu()">
          schlie√üen
        </button>
      </div>
    </div>

    <div class="reset-overlay" id="resetOverlay">
      <div class="reset-dialog">
        <p class="reset-title">Reset?</p>
        <p class="reset-text">
          M√∂chtest du wirklich die Punkte und das gesamte Spiel zur√ºcksetzen?
        </p>
        <div class="reset-buttons">
          <button class="reset-btn cancel" id="resetCancel">Nein</button>
          <button class="reset-btn confirm" id="resetConfirm">Ja</button>
        </div>
      </div>
    </div>

    <div class="hand-overlay" id="handOverlay">
      <div class="hand-dialog">
        <p class="hand-dialog-title">W√§hle deine Hand</p>
        <div class="hand-grid">
          <button class="hand-option" data-hand="üñê">
            <span class="hand-symbol">üñê</span>
          </button>
          <button class="hand-option" data-hand="ü§û">
            <span class="hand-symbol">ü§û</span>
          </button>
          <button class="hand-option" data-hand="ü§ü">
            <span class="hand-symbol">ü§ü</span>
          </button>
          <button class="hand-option" data-hand="üëä">
            <span class="hand-symbol">üëä</span>
          </button>
        </div>
        <div class="hand-buttons">
          <button class="hand-confirm" id="handConfirm">Hand best√§tigen</button>
          <button class="hand-reset" id="handReset">zur√ºcksetzen</button>
        </div>
      </div>
    </div>

    <h1>KIPP SMILEY</h1>

    <div class="card-wrapper">
      <div class="card">
        <div class="card-inner">

          <div class="combo-row" id="comboRow">
            <div class="smiley-hand" id="smileyHand">üñê</div>
            <div class="smiley-face" id="smileyFace">üòÄ</div>
          </div>

          <div class="points-popup" id="pointsPopup"></div>

          <div class="card-message" id="cardMessage">
            üìô = Scrollbare Spielanleitung.<br><br>
            ‚ò∞ = PDF-Spielanleitung herunterladen.
          </div>

          <div class="rules-container" id="rulesContainer">
            <div class="rules-text">

              <!-- Hier steht deine komplette KIPP-SMILEY Scroll-Anleitung
                   (unver√§ndert aus deinem Originalcode) -->
              <h2>KIPP SMILEY Spielanleitung</h2>

              <p><strong>Spieleranzahl:</strong> 1‚Äì4</p>
              <p><strong>Altersempfehlung:</strong> ab 9 Jahren</p>
              <p><strong>Spieldauer:</strong> ca. 20 Minuten</p>
              <p><strong>Spielkategorie:</strong> Logik- &amp; Merkspiel (Hybrid: Physisch + App)</p>

              <div class="rules-separator"></div>

              <h3>Spielmaterial:</h3>
              <p class="bullet">‚Ä¢ 1 KIPP-Box (140x140x70 mm)</p>
              <p class="bullet">‚Ä¢ 1 KIPP-W√ºrfel (70x70x70 mm)</p>
              <p class="bullet">‚Ä¢ 1 Kartonrahmen, 12 Smiley-Kn√∂pfe (‚åÄ 16 mm), 1 Holzkugel (‚åÄ 15 mm)</p>
              <p class="bullet">‚Ä¢ Smartphone/Tablet mit der KIPP-SMILEY-App</p>

              <div class="rules-separator"></div>

              <h3>Spielziel</h3>
              <p>Den W√ºrfel in der Box so zu kippen, dass er deine Kippvorgabe zeigt.</p>

              <div class="rules-separator"></div>

              <h3>Vorbereitung</h3>

              <p><strong>1.</strong> Kartonrahmen auflegen, egal wie gedreht ausgerichtet.</p>

              <p><strong>2.</strong> Kugel ins Boxbodenloch legen.</p>

              <p><strong>3.</strong> W√ºrfel in eine beliebige Boxecke so einlegen,<br>
              dass die abgeschr√§gte Ecke an der Kugel anliegt.</p>

              <p><strong>4.</strong> Beliebige Smileykn√∂pfe in die 4 L√∂cher stecken,<br>
              W√ºrfel einmal kippen ‚Äì weitere 4 Kn√∂pfe stecken,<br>
              wieder kippen, die letzten 4 Kn√∂pfe stecken.<br>
              Der W√ºrfel ist nun voll best√ºckt.</p>

              <div class="rules-separator"></div>

              <h3>Spielbeginn</h3>

              <p>Hinweis:<br>
              Mit "Icon schlie√üen" k√∂nnt ihr jeder Zeit aus der Spielbeschreibung raus, alles in der App probieren und wieder mit dem Icon rein zum Weiterlesen.</p>

              <p><strong>1.</strong> Alle tippen in ihrer App auf ‚Äûstarten‚Äú.</p>

              <p><strong>2.</strong> Jeder w√§hlt dann eine der 4 H√§nde aus.</p>

              <p><strong>3.</strong> Sprecht euch ab, damit jeder eine andere hat.</p>

              <p>Nach der Hand-Wahl habt ihr alle eure erste<br>
              Smileyhand-kopf-Kombi, eure Kippvorgabe, hier im Fenster.</p>

              <p>Ein beliebiger Spieler beginnt und ist mit seiner Zugfolge an der Reihe.</p>

              <div class="rules-separator"></div>

              <h3>Zugfolge</h3>

              <p>Eine Zugfolge besteht immer aus 3 Schritten.</p>

              <h3>1. Ausgangslage pr√ºfen/klicken</h3>

              <p>BEVOR du kippst, schaust du,<br>
              welche 4 Smiley-K(n)√∂pfe am W√ºrfel oben auf sind<br>
              und an welcher Hand sie jeweils liegen.</p>

              <p>Vergleiche dies mit deiner Kippvorgabe in der App<br>
              (Smileyhand-kopf-Kombi).</p>

              <p>Wenn am W√ºrfel dein Smileykopf sichtbar ist,<br>
              klickst du ihn an.</p>

              <p>Liegt er zus√§tzlich genau an deiner Hand,<br>
              klickst du auch die Hand an.</p>

              <p>Siehst du den Smiley-Kopf nicht am W√ºrfel,<br>
              klickst du nichts an.</p>

              <h3>2. Kippen</h3>

              <p>(theoretisch ist immer ein Treffer m√∂glich)</p>

              <p>Sag eine Kippanzahl von 1 bis 6 an<br>
              und kippe den W√ºrfel genau so oft<br>
              in eine beliebige Richtung.</p>

              <h3>3. Kippergebnis pr√ºfen/klicken</h3>

              <p>Bildet jetzt die Lage des W√ºrfels zum Boxrand exakt deine Kippvorgabe,<br>
              dann hast du richtig gekippt.<br>
              Du klickst auf "erkippt".</p>

              <p>Wenn nicht, klickst du auf ‚Äûnicht erkippt‚Äú.</p>

              <p>Der n√§chste Spieler ist an der Reihe.</p>

              <div class="rules-separator"></div>

              <h3>Automatische Punkte-Vergabe</h3>

              <p class="points-heading"><strong>3 Punkte</strong></p>
              <p>
                Sonderfall: Wenn der Smileykopf bereits offen liegt und
                zus√§tzlich an deiner richtigen Hand liegt, ist deine
                Kippvorgabe schon erf√ºllt, bevor du √ºberhaupt kippst.
                Diese einzige von 48 m√∂glichen Ausgangslagen wird als
                Gl√ºcksfall mit 3 Punkten belohnt ‚Äì du setzt daf√ºr einmal aus.
              </p>

              <p class="points-heading"><strong>5 Punkte</strong></p>
              <p>
                Wenn der Kopf offen aufliegt und du deine Kippvorgabe
                erkippt hast. Mit Logik und Merkf√§higkeit gut l√∂sbar,
                da du den Kopf vor dem Kippen sehen konntest.
              </p>

              <p class="points-heading"><strong>8 Punkte</strong></p>
              <p>
                Wenn der Kopf vor dem Kippen nicht sichtbar war und du
                deine Kippvorgabe trotzdem exakt erkippt hast.
                Maximaler Logik-, Ged√§chtnis- und Gl√ºcksanteil ‚Äì
                die schwierigste und lukrativste Variante.
              </p>

              <div class="rules-separator"></div>

              <h3>Zugz√§hler</h3>

              <p>Die App z√§hlt durch die verschiedenen Klicks<br>
              auch die Anzahl der Kippvorg√§nge,<br>
              und nach 6 Zugfolgen wird bei jedem "KIPP STOPP" angezeigt.<br>
              Die Partie ist aus.</p>

              <p>Wer am meisten Punkte hat,<br>
              darf sich KIPPKING nennen.</p>

              <div class="rules-separator"></div>

              <h3>Neue Runde</h3>

              <p>F√ºr eine neue Partie auf "reset" gehen,<br>
              und ihr k√∂nnt den W√ºrfel neu best√ºcken.<br>
              Es gibt etwa 279 Mio Steckvariationen.</p>

              <p>Viel Spannung, Spa√ü und Kopfzerbrechen mit<br>
              KIPP SMILEY.</p>

            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="buttons-row">
      <button class="btn btn-primary" id="btnOwn">erkippt</button>
      <button class="btn btn-undo btn-undo-disabled" id="btnUndo">‚Ü∫</button>
      <button class="btn btn-secondary" id="btnFail">nicht erkippt</button>
    </div>

    <div class="score-area">
      <div class="score-big" id="pointsDisplay">0</div>
      <div class="moves-display" id="movesDisplay">Z√ºge: 0/6</div>
      <div class="start-row">
        <button class="start-btn start-btn-start" id="btnStart">starten</button>
        <button class="start-btn start-btn-close" id="btnClose">schlie√üen</button>
      </div>
    </div>

  </div> <!-- Ende KIPP SMILEY -->

  <!-- =======================
       KIPP FAIRY APP (dein FAIRY-KIPP Code)
       ======================= -->
  <div id="fairy-app-wrapper" style="display:none; margin-top: 8px;">

    <!-- API-Key Banner -->
    <div class="apikey-banner" id="apikey-banner">
      <div class="apikey-inner">
        <span>OpenAI&nbsp;API-Key:</span>
        <input
          id="apikey-input"
          class="apikey-input"
          type="password"
          placeholder="sk-..."
        />
        <button class="apikey-btn" id="apikey-save-btn">OK</button>
      </div>
    </div>

    <div class="app">
      <header class="header">
        <div class="logo-line">
          <span class="logo-fairy">Fairy</span>
          <span class="logo-kipp">KIPP</span>
        </div>
        <div class="tagline">Unendlich viele KIPP-Fabeln</div>
      </header>

      <!-- Fairy Panel -->
      <section class="panel">
        <div class="panel-header">
          <span class="pill pill-blue">Fairy</span>
          <span id="fairy-status" class="status-line"></span>
        </div>

        <div class="button-row">
          <button id="fairy-btn" class="btn-main">FAIRY</button>
          <button id="reveal-motif-btn" class="btn-small hidden">MOTIV</button>
        </div>

        <div class="story-box" id="story-box">
          <div id="story-text" class="story-muted">
            Tippe auf <strong>FAIRY</strong>, um eine neue Fabel zu starten.
          </div>
        </div>

        <div class="story-footer">
          <div class="sentence-indicator" id="sentence-indicator"></div>
        </div>
      </section>

      <!-- Score Panel (FAIRY-Punkte) -->
      <section class="panel">
        <div class="panel-header">
          <span class="pill pill-violet">Punkte</span>
          <span class="score-fairies">
            Erz√§hlte Fairys: <strong id="fairy-count">0</strong> / 6
          </span>
        </div>

        <div class="score-row">
          <div class="score-main">
            <div class="score-label">FAIRY-PUNKTE</div>
            <div class="score-value" id="score-value">0</div>
          </div>
        </div>

        <div class="button-row" style="margin-top: 4px">
          <button id="fairyfund-btn" class="btn-secondary">FAIRY FUND</button>
        </div>
      </section>

      <button id="reset-btn" class="btn-ghost">NEUE PARTIE</button>
    </div>

    <div class="end-overlay" id="end-overlay">
      <div class="end-card">
        <div class="end-title">Fairy End</div>
        <div class="end-score-label">Deine Fairy-Punkte</div>
        <div class="end-score-value" id="end-score-value">0</div>
        <div class="end-sub" id="end-sub"></div>
        <button id="end-newgame-btn" class="btn-secondary">Neue Partie</button>
      </div>
    </div>
  </div>

</div> <!-- club-shell -->

<script>
/* =====================
   KIPP SMILEY ‚Äì Original JS
   (unver√§ndert √ºbernommen)
   ===================== */
const faces = ["üòâ","üòµ‚Äçüí´","üòÅ","üòä","üò†","üòÇ","üòç","üò≤","üòö","üôÑ","üò¨","üôÇ"];
const hands = ["üñê","ü§û","ü§ü","üëä"];

let points = 0;
let gameStarted = false;
let rulesVisible = false;

let selectedHand = null;
let tempSelectedHand = null;

let headClicked = false;
let handClicked = false;
let kippStopp = false;
let isSetzeAusPhase = false;

const maxMoves = 6;
let moves = 0;

/* Undo-State */
let lastState = null;
let canUndo = false;

const faceEl = document.getElementById("smileyFace");
const handEl = document.getElementById("smileyHand");
const comboRow = document.getElementById("comboRow");
const cardMessage = document.getElementById("cardMessage");
const rulesContainer = document.getElementById("rulesContainer");
const pointsDisplay = document.getElementById("pointsDisplay");
const movesDisplay = document.getElementById("movesDisplay");
const btnStart = document.getElementById("btnStart");
const infoIcon = document.getElementById("infoIcon");
const btnUndo = document.getElementById("btnUndo");

const resetOverlay = document.getElementById("resetOverlay");
const resetCancel   = document.getElementById("resetCancel");
const resetConfirm  = document.getElementById("resetConfirm");

const handOverlay   = document.getElementById("handOverlay");
const handOptions   = document.querySelectorAll(".hand-option");
const handConfirm   = document.getElementById("handConfirm");
const handReset     = document.getElementById("handReset");

const pointsPopup   = document.getElementById("pointsPopup");
let pointsTimeout   = null;

/* Men√º */
document.getElementById("menuBtn").onclick = () =>
  document.getElementById("menuOverlay").style.display = "flex";

function closeMenu() {
  document.getElementById("menuOverlay").style.display = "none";
}

function openRulesScroll() {
  closeMenu();
  if (!rulesVisible) infoIcon.click();
}

function openRulesPdf() {
  window.open('KIPPSmileySpielanleitung.PDF', '_blank');
}

/* Undo-Unterst√ºtzung */
function updateUndoButton() {
  if (!btnUndo) return;
  if (canUndo && lastState) {
    btnUndo.disabled = false;
    btnUndo.classList.remove("btn-undo-disabled");
  } else {
    btnUndo.disabled = true;
    btnUndo.classList.add("btn-undo-disabled");
  }
}

function saveLastState() {
  lastState = {
    points,
    moves,
    face: faceEl.textContent,
    hand: handEl.textContent,
    gameStarted,
    kippStopp,
    rulesVisible
  };
  canUndo = true;
  updateUndoButton();
}

/* Hilfsfunktionen */
function randomInt(max){ return Math.floor(Math.random()*max); }

function updateMoves() {
  movesDisplay.textContent = `Z√ºge: ${moves}/${maxMoves}`;
}

function clearSelections() {
  headClicked = false;
  handClicked = false;
  faceEl.classList.remove("selected", "fade-out");
  handEl.classList.remove("selected", "fade-out");
}

function applyHandRotation(el) {
  if (el.textContent === "üëä") {
    el.style.transform = "rotate(-90deg)";
  } else {
    el.style.transform = "none";
  }
}

function showNormalCombo() {
  comboRow.style.display = "flex";
  cardMessage.innerHTML = "";

  if (selectedHand) {
    handEl.textContent = selectedHand;
  } else {
    handEl.textContent = hands[randomInt(hands.length)];
  }
  applyHandRotation(handEl);

  faceEl.textContent = faces[randomInt(faces.length)];
  faceEl.style.fontSize = "5.2rem";
}

function showKippStopp() {
  kippStopp = true;
  clearSelections();

  faceEl.textContent = faces[randomInt(faces.length)];
  if (selectedHand) {
    handEl.textContent = selectedHand;
  } else {
    handEl.textContent = hands[randomInt(hands.length)];
  }
  applyHandRotation(handEl);

  comboRow.style.display = "flex";
  cardMessage.innerHTML = `<div class="kippstopp-title">KIPP STOPP</div>`;
}

/* Punkte-Popup allgemeiner */
function showPointsPopup(value, {
  subText = null,
  changeFaceAfter = false,
  onDone = null
} = {}) {
  if (!pointsPopup) return;

  if (pointsTimeout) {
    clearTimeout(pointsTimeout);
    pointsTimeout = null;
  }

  const isSetzeAus = (subText === "setze aus!");

  pointsPopup.innerHTML =
    `<div class="points-number">${value}</div>
     <div class="points-label">Punkte</div>` +
    (subText ? `<div class="points-sub">${subText}</div>` : "");

  if (headClicked) faceEl.classList.add("fade-out");
  if (handClicked) handEl.classList.add("fade-out");

  if (isSetzeAus && !kippStopp) {
    pointsPopup.classList.add("setze-aus");
    comboRow.style.display = "none";
    cardMessage.style.display = "none";
  } else {
    pointsPopup.classList.remove("setze-aus");
  }

  pointsPopup.classList.add("visible");

  const duration = isSetzeAus ? 8000 : 2000;

  pointsTimeout = setTimeout(() => {
    pointsPopup.classList.remove("visible");

    if (isSetzeAus) {
      pointsPopup.classList.remove("setze-aus");
    }

    clearSelections();

    if (changeFaceAfter && !kippStopp && gameStarted && !rulesVisible) {
      showNormalCombo();
    }

    if (typeof onDone === "function") {
      onDone();
    }
  }, duration);
}

/* Setze-aus-Logik bei Kopf+Hand voraus angeklickt */
function checkSetzeAus() {
  if (!gameStarted || rulesVisible || kippStopp || isSetzeAusPhase) return;
  if (!(headClicked && handClicked)) return;

  saveLastState();

  isSetzeAusPhase = true;

  points += 3;
  pointsDisplay.textContent = points;

  moves += 1;
  updateMoves();

  const allowNewFace = (moves < maxMoves);

  if (moves >= maxMoves) {
    showKippStopp();
  }

  showPointsPopup(3, {
    subText: "setze aus!",
    changeFaceAfter: allowNewFace,
    onDone: () => {
      isSetzeAusPhase = false;
    }
  });
}

/* Hand-Auswahl */
function clearHandOverlaySelection() {
  tempSelectedHand = null;
  handOptions.forEach(b => b.classList.remove("active"));
}

handOptions.forEach(btn => {
  const symbolSpan = btn.querySelector(".hand-symbol");
  const handChar = symbolSpan.textContent;

  if (handChar === "üëä") {
    symbolSpan.style.transform = "rotate(-90deg)";
  }

  btn.onclick = () => {
    tempSelectedHand = handChar;
    handOptions.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  };
});

handConfirm.onclick = () => {
  if (!tempSelectedHand) return;
  selectedHand = tempSelectedHand;
  handOverlay.style.display = "none";
  startGame();
};

handReset.onclick = () => {
  clearHandOverlaySelection();
};

handOverlay.addEventListener("click", (e) => {
  if (e.target === handOverlay) {
    handOverlay.style.display = "none";
    clearHandOverlaySelection();
  }
});

/* Start */
function startGame() {
  gameStarted = true;
  kippStopp = false;
  isSetzeAusPhase = false;
  points = 0;
  moves = 0;
  pointsDisplay.textContent = "0";
  updateMoves();

  clearSelections();
  comboRow.style.display = "flex";
  cardMessage.innerHTML = "";
  pointsPopup.style.display = "flex";
  pointsPopup.classList.remove("visible","setze-aus");
  pointsPopup.innerHTML = "";

  btnStart.textContent = "Reset";
  btnStart.classList.add("reset-mode");

  lastState = null;
  canUndo = false;
  updateUndoButton();

  showNormalCombo();
}

btnStart.onclick = () => {
  if (rulesVisible) return;

  if (!gameStarted) {
    if (!selectedHand) {
      clearHandOverlaySelection();
      handOverlay.style.display = "flex";
      return;
    }
    startGame();
  } else {
    resetOverlay.style.display = "flex";
  }
};

/* Reset-Dialog */
resetCancel.onclick = () => {
  resetOverlay.style.display = "none";
};

resetConfirm.onclick = () => {
  resetOverlay.style.display = "none";

  gameStarted = false;
  kippStopp = false;
  isSetzeAusPhase = false;
  points = 0;
  moves = 0;
  pointsDisplay.textContent = "0";
  updateMoves();

  selectedHand = null;
  clearHandOverlaySelection();

  clearSelections();
  handEl.style.display = "inline-block";
  applyHandRotation(handEl);
  faceEl.textContent = "üòÄ";
  faceEl.style.fontSize = "5.2rem";
  comboRow.style.display = "none";

  if (pointsTimeout) {
    clearTimeout(pointsTimeout);
    pointsTimeout = null;
  }
  pointsPopup.classList.remove("visible");
  pointsPopup.classList.remove("setze-aus");
  pointsPopup.innerHTML = "";
  pointsPopup.style.display = "flex";

  cardMessage.innerHTML =
    "üìô = Scrollbare Spielanleitung.<br><br>‚ò∞ = PDF-Spielanleitung herunterladen.";
  cardMessage.style.display = "block";

  btnStart.textContent = "starten";
  btnStart.classList.remove("reset-mode");

  lastState = null;
  canUndo = false;
  updateUndoButton();
};

/* schlie√üen-Button */
document.getElementById("btnClose").onclick = () => {
  if (window.confirm("App wirklich schlie√üen?")) window.close();
};

/* Kopf / Hand anklickbar */
faceEl.onclick = () => {
  if (!gameStarted || rulesVisible || kippStopp || isSetzeAusPhase) return;

  headClicked = !headClicked;
  faceEl.classList.toggle("selected", headClicked);

  if (!headClicked) {
    handClicked = false;
    handEl.classList.remove("selected");
  }

  checkSetzeAus();
};

handEl.onclick = () => {
  if (!gameStarted || rulesVisible || kippStopp || isSetzeAusPhase) return;
  if (!headClicked) return;

  handClicked = !handClicked;
  handEl.classList.toggle("selected", handClicked);

  checkSetzeAus();
};

/* Buttons: erkippt / nicht erkippt */
document.getElementById("btnOwn").onclick = () => {
  if (!gameStarted || rulesVisible || kippStopp || isSetzeAusPhase) return;
  if (moves >= maxMoves) return;

  saveLastState();

  let addPoints = 0;
  let subText = null;
  let changeFace = false;

  if (headClicked && !handClicked) {
    addPoints = 5;
    changeFace = true;
  } else if (!headClicked && !handClicked) {
    addPoints = 8;
    changeFace = true;
  } else if (headClicked && handClicked) {
    addPoints = 0;
    subText = "setze aus!";
    changeFace = true;
  } else {
    addPoints = 0;
    changeFace = false;
  }

  if (addPoints !== 0) {
    points += addPoints;
    pointsDisplay.textContent = points;
  }

  moves += 1;
  updateMoves();

  const allowNewFace = changeFace && (moves < maxMoves);

  if (moves >= maxMoves) {
    showKippStopp();
  }

  showPointsPopup(addPoints === 0 ? 0 : addPoints, {
    subText,
    changeFaceAfter: allowNewFace
  });
};

document.getElementById("btnFail").onclick = () => {
  if (!gameStarted || rulesVisible || kippStopp || isSetzeAusPhase) return;
  if (moves >= maxMoves) return;

  saveLastState();

  moves += 1;
  updateMoves();

  if (moves >= maxMoves) {
    showKippStopp();
  }

  showPointsPopup(0, {
    subText: null,
    changeFaceAfter: false
  });
};

/* Undo-Button */
btnUndo.onclick = () => {
  if (!canUndo || !lastState) return;

  if (pointsTimeout) {
    clearTimeout(pointsTimeout);
    pointsTimeout = null;
  }

  points = lastState.points;
  pointsDisplay.textContent = points;
  moves = lastState.moves;
  updateMoves();
  gameStarted = lastState.gameStarted;
  kippStopp = lastState.kippStopp;
  rulesVisible = lastState.rulesVisible;
  isSetzeAusPhase = false;

  pointsPopup.classList.remove("visible","setze-aus");
  pointsPopup.innerHTML = "";
  pointsPopup.style.display = "flex";

  clearSelections();

  faceEl.textContent = lastState.face;
  faceEl.style.fontSize = "5.2rem";
  handEl.textContent = lastState.hand;
  applyHandRotation(handEl);

  if (rulesVisible) {
    rulesContainer.style.display = "block";
    comboRow.style.display = "none";
    cardMessage.style.display = "none";
    infoIcon.classList.add("show-close");
  } else if (gameStarted) {
    rulesContainer.style.display = "none";
    comboRow.style.display = "flex";
    cardMessage.innerHTML = "";
    cardMessage.style.display = "block";
    infoIcon.classList.remove("show-close");
  } else {
    rulesContainer.style.display = "none";
    comboRow.style.display = "none";
    cardMessage.innerHTML =
      "üìô = Scrollbare Spielanleitung.<br><br>‚ò∞ = PDF-Spielanleitung herunterladen.";
    cardMessage.style.display = "block";
    infoIcon.classList.remove("show-close");
  }

  canUndo = false;
  updateUndoButton();
};

/* Spielanleitung ein-/ausblenden */
infoIcon.onclick = () => {
  rulesVisible = !rulesVisible;

  if (rulesVisible) {
    infoIcon.classList.add("show-close");
    comboRow.style.display = "none";
    cardMessage.style.display = "none";
    rulesContainer.style.display = "block";
    pointsPopup.style.display = "none";
  } else {
    infoIcon.classList.remove("show-close");
    rulesContainer.style.display = "none";

    pointsPopup.style.display = "flex";

    if (gameStarted) {
      cardMessage.innerHTML = "";
      cardMessage.style.display = "block";
      comboRow.style.display = "flex";
    } else {
      cardMessage.innerHTML =
        "üìô = Scrollbare Spielanleitung.<br><br>‚ò∞ = PDF-Spielanleitung herunterladen.";
      cardMessage.style.display = "block";
      comboRow.style.display = "none";
    }
  }
};

updateUndoButton();

/* =====================
   FAIRY KIPP ‚Äì dein vorhandener JS-Code
   (logisch unver√§ndert)
   ===================== */
const OPENAI_CHAT_URL = "https://api.openai.com/v1/chat/completions";
const OPENAI_MODEL = "gpt-4o-mini";
const APIKEY_STORAGE_KEY = "fairykipp_openai_key";

const motifsData = [
  { key: "Wasserball",  article: "der",  noun: "Wasserball"  },
  { key: "Auto",        article: "das",  noun: "Auto"        },
  { key: "Farbfleck",   article: "der",  noun: "Farbfleck"   },
  { key: "Buch",        article: "das",  noun: "Buch"        },
  { key: "Gie√ükanne",   article: "die",  noun: "Gie√ükanne"   },
  { key: "Kerze",       article: "die",  noun: "Kerze"       },
  { key: "Blume",       article: "die",  noun: "Blume"       },
  { key: "Fisch",       article: "der",  noun: "Fisch"       },
  { key: "Schmetterling", article: "der", noun: "Schmetterling" },
  { key: "Schuh",       article: "der",  noun: "Schuh"       },
  { key: "Tasse",       article: "die",  noun: "Tasse"       },
  { key: "T-Shirt",     article: "das",  noun: "T-Shirt"     }
];

const motifVerbBase = {
  Wasserball: [
    "platschte","plumpste","spritzte","h√ºpfte","polterte","ploppte"
  ],
  Auto: [
    "brummte","knatterte","r√∂hrte","tuckerte","schnurrte",
    "hupte","quietschte","dr√∂hnte","heulte","fauchte"
  ],
  Farbfleck: [
    "tropfte","kleckste","spritzte","schmierte","kleckerte","schmatzte"
  ],
  Buch: [
    "raschelte","bl√§tterte","murmelte","seufzte","fl√ºsterte",
    "knisterte","wisperte","brummte","klappte"
  ],
  Gie√ükanne: [
    "pl√§tscherte","tropfte","gluckerte","schwappte","gluckste","schwallte","gurgelte"
  ],
  Kerze: [
    "flackerte","knisterte","zischte","glomm","fl√ºsterte","seufzte","hauchte"
  ],
  Blume: [
    "fl√ºsterte","hauchte","seufzte","wisperte","raschelte","murmelte","s√§uselte","fl√∂tete"
  ],
  Fisch: [
    "blubberte","gluckerte","sprudelte","murmelte","schmatzte",
    "zischte","schl√ºrfte","schwapperte","gluckste"
  ],
  Schmetterling: [
    "fl√ºsterte","wisperte","hauchte","seufzte","s√§uselte",
    "murmelte","kicherte","trillierte","zirpte"
  ],
  Schuh: [
    "quietschte","klackte","schlurfte","knirschte","tappte",
    "stapfte","polterte","scharrte","knarzte"
  ],
  Tasse: [
    "klirrte","klimperte","klackte","knackte","zitterte",
    "murmelte","summte","brummte","seufzte"
  ],
  "T-Shirt": [
    "raschelte","flatterte","seufzte","wisperte","knisterte",
    "murmelte","hauchte","s√§uselte"
  ]
};

const fairyBtn = document.getElementById("fairy-btn");
const revealMotifBtn = document.getElementById("reveal-motif-btn");
const fairyStatus = document.getElementById("fairy-status");
const storyTextEl = document.getElementById("story-text");
const sentenceIndicator = document.getElementById("sentence-indicator");

const scoreValueEl = document.getElementById("score-value");
const fairyCountEl = document.getElementById("fairy-count");
const fairyFundBtn = document.getElementById("fairyfund-btn");
const resetBtnFairy = document.getElementById("reset-btn");

const endOverlay = document.getElementById("end-overlay");
const endScoreValue = document.getElementById("end-score-value");
const endNewGameBtn = document.getElementById("end-newgame-btn");
const endSub = document.getElementById("end-sub");

const apikeyBanner = document.getElementById("apikey-banner");
const apikeyInput = document.getElementById("apikey-input");
const apikeySaveBtn = document.getElementById("apikey-save-btn");

let apiKey = null;

let unusedMotifs = [];
let unusedVerbsByMotif = {};

let currentMotif = null;
let currentVerb = null;
let currentStoryText = "";
let currentMotifDisplay = "";
let currentFairyOwnedByThisDevice = false;

let scoreFairy = 0;
let narratedFairies = 0;
const maxFairies = 6;

function shuffleArray(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function setFairyStatus(msg, isError = false) {
  fairyStatus.textContent = msg || "";
  fairyStatus.classList.toggle("status-error", isError);
}

function updateScoreFairyDisplay() {
  scoreValueEl.textContent = String(scoreFairy);
}

function updateFairyCountDisplay() {
  fairyCountEl.textContent = String(narratedFairies);
}

function showEndScreenFairy() {
  endScoreValue.textContent = String(scoreFairy);
  endSub.textContent = "";
  endOverlay.style.display = "flex";
}

function resetGameStateFairy() {
  scoreFairy = 0;
  narratedFairies = 0;
  currentMotif = null;
  currentVerb = null;
  currentStoryText = "";
  currentMotifDisplay = "";
  currentFairyOwnedByThisDevice = false;

  storyTextEl.textContent =
    "Tippe auf FAIRY, um eine neue Fabel zu starten.";
  storyTextEl.classList.add("story-muted");
  storyTextEl.classList.remove("motif-big");
  storyTextEl.style.whiteSpace = "normal";
  revealMotifBtn.classList.add("hidden");
  sentenceIndicator.textContent = "";
  setFairyStatus("");

  updateScoreFairyDisplay();
  updateFairyCountDisplay();
  endOverlay.style.display = "none";
}

function initUnusedMotifs() {
  unusedMotifs = motifsData.slice();
}

function chooseMotifNoImmediateRepeat() {
  if (unusedMotifs.length === 0) {
    initUnusedMotifs();
  }
  const idx = Math.floor(Math.random() * (unusedMotifs.length));
  const motif = unusedMotifs[idx];
  unusedMotifs.splice(idx, 1);
  return motif;
}

function getAllowedVerbsForMotif(noun) {
  const base = motifVerbBase[noun];
  return base ? base.slice() : [];
}

function initUnusedVerbsForMotif(noun) {
  const all = getAllowedVerbsForMotif(noun);
  unusedVerbsByMotif[noun] = shuffleArray(all);
}

function chooseVerbForMotif(noun) {
  if (!unusedVerbsByMotif[noun] || unusedVerbsByMotif[noun].length === 0) {
    initUnusedVerbsForMotif(noun);
  }
  return unusedVerbsByMotif[noun].pop();
}

function loadApiKeyFromStorage() {
  const stored = window.localStorage.getItem(APIKEY_STORAGE_KEY);
  if (stored && stored.startsWith("sk-")) {
    apiKey = stored;
    if (apikeyBanner) apikeyBanner.classList.add("hidden");
  } else {
    apiKey = null;
    if (apikeyBanner) apikeyBanner.classList.remove("hidden");
  }
}

function saveApiKeyToStorage(key) {
  apiKey = key;
  window.localStorage.setItem(APIKEY_STORAGE_KEY, key);
  if (apikeyBanner) apikeyBanner.classList.add("hidden");
}

/* KI-Text splitten ‚Äì letztes Wort = Motiv */
function splitTextAndMotif(fullText, motifObj, verb) {
  if (!fullText) return null;

  let trimmed = fullText.replace(/\s+/g, " ").trim();
  const tokens = trimmed.split(" ");
  if (tokens.length < 4) return null;

  let lastToken = tokens[tokens.length - 1];
  let motifCandidate = lastToken.replace(/[.,!?;"‚Äú‚Äù‚Äû]+$/g, "");

  if (motifCandidate.toLowerCase() !== motifObj.noun.toLowerCase()) {
    return null;
  }

  let secondLastRaw = tokens[tokens.length - 2];
  let thirdLastRaw = tokens[tokens.length - 3];

  let secondLast = secondLastRaw.replace(/[.,!?;"‚Äú‚Äù‚Äû]+$/g, "").toLowerCase();
  let thirdLast = thirdLastRaw.replace(/[.,!?;"‚Äú‚Äù‚Äû]+$/g, "").toLowerCase();

  if (secondLast !== motifObj.article.toLowerCase()) {
    return null;
  }

  const allowedVerbs = getAllowedVerbsForMotif(motifObj.noun)
    .concat(unusedVerbsByMotif[motifObj.noun] || [])
    .map((v) => v.toLowerCase());

  if (!allowedVerbs.includes(thirdLast)) {
    return null;
  }

  const beforeTokens = tokens.slice(0, -1);
  const lowerMotif = motifObj.noun.toLowerCase();
  for (const t of beforeTokens) {
    const cleaned = t.replace(/[.,!?;"‚Äú‚Äù‚Äû]+$/g, "").toLowerCase();
    if (cleaned === lowerMotif) {
      return null;
    }
  }

  const mainTokens = tokens.slice(0, -1);
  const mainText = mainTokens.join(" ");

  return {
    mainText,
    motifDisplay: motifObj.noun.toUpperCase()
  };
}

async function generateFairyFromOpenAI(retryCount = 0) {
  if (!apiKey) {
    setFairyStatus("Bitte zuerst API-Key oben eingeben.", true);
    if (apikeyBanner) apikeyBanner.classList.remove("hidden");
    return;
  }

  if (narratedFairies >= maxFairies) {
    setFairyStatus("Diese Partie ist bereits beendet.", true);
    return;
  }

  setFairyStatus("Fairy wird gezaubert ‚Ä¶");
  storyTextEl.textContent = "‚Ä¶ KI schreibt eine neue Fabel ‚Ä¶";
  storyTextEl.classList.add("story-muted");
  storyTextEl.classList.remove("motif-big");
  storyTextEl.style.whiteSpace = "normal";
  revealMotifBtn.classList.add("hidden");
  sentenceIndicator.textContent = "";

  const motifObj = chooseMotifNoImmediateRepeat();
  const verb = chooseVerbForMotif(motifObj.noun);

  currentMotif = motifObj;
  currentVerb = verb;

  const tailPhrase = `${verb} ${motifObj.article} ${motifObj.noun}`;

  const systemMessage = {
    role: "system",
    content:
      "Du schreibst sehr kurze Fabeltexte auf Deutsch f√ºr ein Gesellschaftsspiel.\n" +
      "Du musst GENAU zwei S√§tze liefern, insgesamt etwa 18‚Äì26 W√∂rter.\n" +
      "Regeln:\n" +
      "- Schreibe in der dritten Person (Er/Sie/Es oder neutrale Beobachtung).\n" +
      "- Keine Farbw√∂rter (blau, gr√ºn, orange, violett usw.).\n" +
      "- Verwende das Motivwort nur in der Schlussphrase, die ich dir nenne.\n" +
      "- Kein Genitiv.\n" +
      "- Kein 'sagte', 'meinte', 'dachte'.\n"
  };

  const userMessage = {
    role: "user",
    content:
      "Die unsichtbare Hauptfigur dieser Fabel ist: \"" +
      motifObj.noun +
      "\".\n" +
      "Schreibe GENAU zwei zusammenh√§ngende S√§tze, insgesamt ca. 18‚Äì26 W√∂rter.\n" +
      "Der erste Satz beschreibt die Situation, ohne das Wort \"" +
      motifObj.noun +
      "\" und ohne Farbw√∂rter.\n" +
      "Der zweite Satz enth√§lt eine w√∂rtliche Rede, die zum Motiv passt.\n" +
      "Am ENDE deiner gesamten Ausgabe m√ºssen GENAU diese drei W√∂rter in dieser Reihenfolge stehen:\n" +
      "\"" +
      tailPhrase +
      "\"\n" +
      "Du darfst diese drei W√∂rter nicht ver√§ndern (keine Synonyme, keine Umstellung, keine Erweiterung).\n" +
      "Verwende das Motivwort \"" +
      motifObj.noun +
      "\" sonst nirgends im Text.\n"
  };

  try {
    const response = await fetch(OPENAI_CHAT_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + apiKey
      },
      body: JSON.stringify({
        model: OPENAI_MODEL,
        messages: [systemMessage, userMessage],
        temperature: 0.8,
        max_tokens: 220
      })
    });

    if (!response.ok) {
      throw new Error("HTTP-Fehler: " + response.status);
    }

    const data = await response.json();
    let text = data.choices?.[0]?.message?.content?.trim() || "";

    const result = splitTextAndMotif(text, motifObj, verb);

    if (!result && retryCount < 3) {
      return await generateFairyFromOpenAI(retryCount + 1);
    }

    if (!result && retryCount >= 3) {
      const fallback =
        "Etwas Unbenanntes wartete geduldig am Rand des Spielfelds. " +
        "\"Jetzt kommt mein Moment\", murmelte die.";
      currentStoryText = fallback;
      currentMotifDisplay = motifObj.noun.toUpperCase();
      currentFairyOwnedByThisDevice = true;

      storyTextEl.classList.remove("story-muted");
      storyTextEl.classList.remove("motif-big");
      storyTextEl.style.whiteSpace = "normal";
      storyTextEl.textContent = currentStoryText;
      revealMotifBtn.classList.remove("hidden");
      sentenceIndicator.textContent = "";
      setFairyStatus("Neue Fabel ist aktiv (Fallback).");
      return;
    }

    currentStoryText = result.mainText;
    currentMotifDisplay = result.motifDisplay;
    currentFairyOwnedByThisDevice = true;

    storyTextEl.classList.remove("story-muted");
    storyTextEl.classList.remove("motif-big");
    storyTextEl.style.whiteSpace = "normal";
    storyTextEl.textContent = currentStoryText;
    revealMotifBtn.classList.remove("hidden");
    sentenceIndicator.textContent = "";
    setFairyStatus("Neue Fabel ist aktiv.");
  } catch (err) {
    console.error(err);
    setFairyStatus(
      "Fehler beim Laden der Fairy (Internet oder API-Key pr√ºfen).",
      true
    );
    storyTextEl.textContent =
      "Die Fairy hat sich im Nebel verirrt. Pr√ºfe bitte Internetverbindung und API-Key.";
    storyTextEl.classList.remove("story-muted");
  }
}

/* Event-Listener FAIRY */
if (fairyBtn) {
  fairyBtn.addEventListener("click", async () => {
    await generateFairyFromOpenAI();
  });
}

if (revealMotifBtn) {
  revealMotifBtn.addEventListener("click", () => {
    if (!currentMotifDisplay) return;

    storyTextEl.classList.remove("story-muted");
    storyTextEl.classList.add("motif-big");
    storyTextEl.textContent = currentMotifDisplay;

    if (
      currentMotif &&
      currentMotif.noun &&
      currentMotif.noun.toLowerCase() === "schmetterling"
    ) {
      storyTextEl.style.whiteSpace = "normal";
    } else {
      storyTextEl.style.whiteSpace = "nowrap";
    }
  });
}

if (fairyFundBtn) {
  fairyFundBtn.addEventListener("click", () => {
    if (!currentStoryText && !currentMotifDisplay) {
      setFairyStatus(
        "Erst eine Fabel starten, dann kannst du FAIRY FUND nutzen.",
        true
      );
      return;
    }

    const add = currentFairyOwnedByThisDevice ? 3 : 2;
    scoreFairy += add;
    updateScoreFairyDisplay();

    narratedFairies += 1;
    if (narratedFairies > maxFairies) {
      narratedFairies = maxFairies;
    }
    updateFairyCountDisplay();

    currentMotif = null;
    currentVerb = null;
    currentStoryText = "";
    currentMotifDisplay = "";
    currentFairyOwnedByThisDevice = false;

    storyTextEl.textContent =
      "Fabel verbraucht. Starte die n√§chste mit einem Tipp auf FAIRY.";
    storyTextEl.classList.add("story-muted");
    storyTextEl.classList.remove("motif-big");
    storyTextEl.style.whiteSpace = "normal";
    revealMotifBtn.classList.add("hidden");
    sentenceIndicator.textContent = "";
    setFairyStatus("");

    if (narratedFairies >= maxFairies) {
      showEndScreenFairy();
    }
  });
}

if (resetBtnFairy) {
  resetBtnFairy.addEventListener("click", () => {
    resetGameStateFairy();
  });
}

if (endNewGameBtn) {
  endNewGameBtn.addEventListener("click", () => {
    resetGameStateFairy();
  });
}

if (apikeySaveBtn) {
  apikeySaveBtn.addEventListener("click", () => {
    const val = apikeyInput.value.trim();
    if (!val || !val.startsWith("sk-")) {
      alert("Bitte einen g√ºltigen OpenAI-API-Key eingeben (beginnt mit 'sk-').");
      return;
    }
    saveApiKeyToStorage(val);
  });
}

if (apikeyInput) {
  apikeyInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      apikeySaveBtn.click();
    }
  });
}

function initFairy() {
  loadApiKeyFromStorage();
  initUnusedMotifs();
  updateScoreFairyDisplay();
  updateFairyCountDisplay();
  if (sentenceIndicator) sentenceIndicator.textContent = "";
}
initFairy();

/* =====================
   Modus-Schalter KIPP CLUB
   ===================== */
const modeSmileyBtn = document.getElementById("modeSmiley");
const modeFairyBtn = document.getElementById("modeFairy");
const smileyApp = document.getElementById("smiley-app");
const fairyAppWrapper = document.getElementById("fairy-app-wrapper");

function setMode(mode) {
  if (mode === "smiley") {
    smileyApp.style.display = "block";
    fairyAppWrapper.style.display = "none";
    modeSmileyBtn.classList.add("active");
    modeFairyBtn.classList.remove("active");
  } else {
    smileyApp.style.display = "none";
    fairyAppWrapper.style.display = "block";
    modeSmileyBtn.classList.remove("active");
    modeFairyBtn.classList.add("active");
  }
}

modeSmileyBtn.addEventListener("click", () => setMode("smiley"));
modeFairyBtn.addEventListener("click", () => setMode("fairy"));

</script>

</body>
</html>
