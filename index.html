<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Fairy KIPP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@400;600;700&display=swap"
    rel="stylesheet"
  >
  <style>
    :root {
      --bg: #050505;
      --card: #141414;
      --card-soft: #1f1f1f;
      --orange: #ffa726;
      --violet: #a41b85; /* dein Violett */
      --violet-dark: #7c1064;
      --text-main: #ffffff;
      --text-soft: #c7c7c7;
      --error: #ff6b81;
      --blue: #1580ff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #1a1a1a 0, #000 55%, #000 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 540px;
      padding: 24px 16px 40px;
    }

    .title {
      text-align: center;
      margin-bottom: 12px;
    }

    .title-main {
      font-size: 42px;
      line-height: 1;
    }

    .title-main span.fairy {
      font-family: "Pacifico", cursive;
      color: var(--orange);
      text-shadow: 0 0 18px rgba(255, 167, 38, 0.7);
      margin-right: 4px;
    }

    .title-main span.kipp {
      font-weight: 800;
      letter-spacing: 0.08em;
      color: #1fa0ff;
      text-transform: uppercase;
    }

    .subtitle {
      font-size: 15px;
      color: var(--text-soft);
      margin-top: 8px;
    }

    .card {
      background: radial-gradient(circle at top, #262626 0, var(--card) 45%, #050505 100%);
      border-radius: 26px;
      padding: 18px 16px 22px;
      box-shadow:
        0 24px 50px rgba(0, 0, 0, 0.85),
        0 0 0 1px rgba(255, 255, 255, 0.03);
      margin-bottom: 18px;
    }

    .api-row {
      display: flex;
      gap: 8px;
      align-items: center;
      background: #050505;
      border-radius: 999px;
      padding: 6px 8px 6px 16px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.06);
      margin-bottom: 18px;
    }

    .api-row-label {
      font-size: 12px;
      color: var(--text-soft);
      white-space: nowrap;
    }

    #apiKeyInput {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-main);
      font-size: 13px;
      letter-spacing: 0.12em;
    }

    #apiKeyInput::placeholder {
      color: rgba(255, 255, 255, 0.2);
    }

    .pill-button {
      border-radius: 999px;
      border: none;
      padding: 8px 18px;
      font-weight: 700;
      font-size: 13px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      cursor: pointer;
      background: linear-gradient(135deg, var(--violet), var(--violet-dark));
      color: #fff;
      box-shadow:
        0 8px 18px rgba(164, 27, 133, 0.6),
        0 0 0 1px rgba(255, 255, 255, 0.08);
    }

    .pill-button:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
    }

    .fairy-button {
      width: 100%;
      border-radius: 100px;
      padding: 18px 16px;
      border: none;
      font-size: 26px;
      font-weight: 800;
      letter-spacing: 0.25em;
      text-indent: 0.25em;
      text-transform: uppercase;
      cursor: pointer;
      background: radial-gradient(circle at top, #ffd27f 0, var(--orange) 45%, #ff9100 100%);
      color: #3b2100;
      box-shadow:
        0 16px 38px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(255, 255, 255, 0.08);
      margin-bottom: 18px;
    }

    .fairy-button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: 0 5px 16px rgba(0, 0, 0, 0.8);
    }

    .story-box {
      background: rgba(0, 0, 0, 0.76);
      border-radius: 22px;
      padding: 16px 14px 18px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.06);
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 10px;
    }

    #storyText {
      font-size: 18px;
      line-height: 1.45;
    }

    .story-hint {
      font-size: 13px;
      color: var(--text-soft);
    }

    .story-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
    }

    .story-footer button {
      min-width: 130px;
    }

    .story-footer button span {
      font-size: 13px;
    }

    .story-footer button.disabled-vis {
      opacity: 0.35;
      box-shadow: none;
      cursor: default;
    }

    /* Punkte-Karte */

    .points-card {
      background: var(--card-soft);
      border-radius: 22px;
      padding: 16px 16px 20px;
      box-shadow:
        0 16px 34px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(255, 255, 255, 0.05);
    }

    .points-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .points-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--violet);
      text-shadow: 0 0 12px rgba(164, 27, 133, 0.7);
    }

    .points-sub {
      font-size: 13px;
      color: var(--text-soft);
    }

    .points-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 6px;
      margin-bottom: 10px;
    }

    #pointsValue {
      font-size: 40px;
      font-weight: 800;
      color: #ffc947;
      text-shadow: 0 0 20px rgba(255, 201, 71, 0.85);
    }

    #fairiesCount {
      font-size: 16px;
      color: var(--text-main);
    }

    .points-hint {
      font-size: 13px;
      color: var(--text-soft);
      line-height: 1.45;
    }

    .status-line {
      margin-top: 10px;
      font-size: 13px;
      color: var(--error);
      min-height: 17px;
    }

    .status-line.ok {
      color: #8bc34a;
    }

    /* kleine Anpassungen für sehr kleine Bildschirme */
    @media (max-width: 380px) {
      .title-main {
        font-size: 36px;
      }

      .fairy-button {
        font-size: 22px;
        letter-spacing: 0.18em;
      }

      #storyText {
        font-size: 16px;
      }

      #pointsValue {
        font-size: 34px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="title">
      <div class="title-main">
        <span class="fairy">Fairy</span>
        <span class="kipp">KIPP</span>
      </div>
      <div class="subtitle">Unendlich viele KIPP-Geschichten</div>
    </header>

    <section class="card">
      <!-- API-Key-Zeile -->
      <div class="api-row">
        <div class="api-row-label">OpenAI&nbsp;API-Key:</div>
        <input
          id="apiKeyInput"
          type="password"
          autocomplete="off"
          spellcheck="false"
          placeholder="sk-••••••••••••••••••••••••"
        />
        <button id="apiKeySaveBtn" class="pill-button">OK</button>
      </div>

      <!-- FAIRY-Button -->
      <button id="fairyBtn" class="fairy-button">FAIRY</button>

      <!-- Story-Box -->
      <div class="story-box">
        <div id="storyText">
          Tippe auf FAIRY, um eine neue Geschichte zu starten.
        </div>
        <div class="story-hint" id="storyHint">
          Die Fairy kommt in drei kurzen Sätzen. Drück nach jedem Satz auf WEITER.
        </div>
        <div class="story-footer">
          <button id="weiterBtn" class="pill-button disabled-vis" disabled>
            <span>WEITER</span>
          </button>
        </div>
      </div>

      <div id="statusLine" class="status-line"></div>
    </section>

    <!-- Punkte-Karte -->
    <section class="points-card">
      <div class="points-header">
        <div class="points-title">Fairy-Punkte</div>
        <div class="points-sub">
          Erzählte Fairies: <span id="fairiesCount">0 / 6</span>
        </div>
      </div>

      <div class="points-row">
        <div id="pointsValue">0</div>
      </div>

      <div class="points-hint">
        Jede erzählte Fairy bringt einen Punkt. Sammle so viele wie möglich – dann
        ist es Zeit für eine neue KIPP-Runde.
      </div>
    </section>
  </div>

  <script>
    // ------- Grund-Konstanten -------
    const STORAGE_KEY = "fairykipp_api_key";
    const MAX_FAIRIES_PER_GAME = 6;
    const MODEL_NAME = "gpt-5-mini"; // Modellname aus deiner OpenAI-Konsole

    // ------- DOM -------
    const apiKeyInput = document.getElementById("apiKeyInput");
    const apiKeySaveBtn = document.getElementById("apiKeySaveBtn");
    const fairyBtn = document.getElementById("fairyBtn");
    const weiterBtn = document.getElementById("weiterBtn");
    const storyText = document.getElementById("storyText");
    const storyHint = document.getElementById("storyHint");
    const statusLine = document.getElementById("statusLine");
    const pointsValue = document.getElementById("pointsValue");
    const fairiesCount = document.getElementById("fairiesCount");

    // ------- State -------
    let apiKey = "";
    let currentSentences = [];
    let currentSentenceIndex = 0;
    let points = 0;
    let toldFairies = 0;
    let isLoadingFairy = false;

    // ------- Helfer -------
    function loadApiKeyFromStorage() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        apiKey = stored;
        apiKeyInput.value = stored;
        statusLine.textContent = "API-Key aus dem Speicher geladen.";
        statusLine.classList.add("ok");
      }
    }

    function saveApiKey() {
      const value = apiKeyInput.value.trim();
      if (!value) {
        apiKey = "";
        localStorage.removeItem(STORAGE_KEY);
        statusLine.textContent = "Kein API-Key eingetragen.";
        statusLine.classList.remove("ok");
        return;
      }
      apiKey = value;
      localStorage.setItem(STORAGE_KEY, value);
      statusLine.textContent = "API-Key gespeichert. Du kannst jetzt FAIRYs laden.";
      statusLine.classList.add("ok");
    }

    function resetStoryState() {
      currentSentences = [];
      currentSentenceIndex = 0;
      weiterBtn.disabled = true;
      weiterBtn.classList.add("disabled-vis");
    }

    function showError(message) {
      statusLine.textContent = message;
      statusLine.classList.remove("ok");
    }

    function updatePointsUI() {
      pointsValue.textContent = points.toString();
      fairiesCount.textContent = toldFairies + " / " + MAX_FAIRIES_PER_GAME;
    }

    function setLoadingFairy(loading) {
      isLoadingFairy = loading;
      fairyBtn.disabled = loading;
      if (loading) {
        fairyBtn.textContent = "LÄDT …";
      } else {
        fairyBtn.textContent = "FAIRY";
      }
    }

    // ------- OpenAI-Aufruf -------
    async function fetchFairyFromOpenAI() {
      if (!apiKey) {
        showError("Kein API-Key hinterlegt. Bitte oben eintragen und OK drücken.");
        return;
      }

      if (toldFairies >= MAX_FAIRIES_PER_GAME) {
        showError("Diese Runde hat schon 6 Fairies. Starte eine neue Partie auf dem Spielplan.");
        return;
      }

      resetStoryState();
      setLoadingFairy(true);
      storyText.textContent = "Die Fairy wird gerade erzählt …";
      storyHint.textContent = "Einen Augenblick Geduld.";

      try {
        const prompt =
          "Du bist der Fairy-Erzähler für ein Brettspiel namens KIPP.\n" +
          "Erfinde eine einzige, sehr kurze KIPP-Geschichte auf Deutsch.\n" +
          "Gib GENAU 3 Sätze aus, getrennt durch '###'.\n" +
          "Regeln:\n" +
          "1. Satz: kurze, bildhafte Szene mit einem Gegenstand aus der Kinderwelt, ohne seine Farbe zu nennen.\n" +
          "2. Satz: weiterer kurzer Hinweis, immer noch ohne die gesuchte Farbe wörtlich zu nennen.\n" +
          "3. Satz: sehr kurzer Lösungssatz, der eindeutig eine der Spielfarben nennt: ORANGE, GELB, GRÜN oder VIOLETT (in Großbuchstaben).\n" +
          "Jeder Satz maximal 15 Wörter. Kein Extra-Text, nur diese 3 Sätze mit '###' dazwischen.";

        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + apiKey
          },
          body: JSON.stringify({
            model: MODEL_NAME,
            messages: [
              {
                role: "system",
                content:
                  "Du erzählst sehr kurze, klare Fairytales für ein KIPP-Brettspiel. " +
                  "Du befolgst strikt alle Anweisungen des Nutzers und hältst dich kurz."
              },
              { role: "user", content: prompt }
            ],
            temperature: 0.8,
            max_tokens: 160
          })
        });

        if (!response.ok) {
          console.error("OpenAI HTTP-Fehler:", response.status, await response.text());
          throw new Error("OpenAI-Antwort war nicht erfolgreich.");
        }

        const data = await response.json();
        const content = data.choices?.[0]?.message?.content ?? "";

        if (!content) {
          throw new Error("Leere Antwort vom Modell.");
        }

        const parts = content.split("###").map((s) => s.trim()).filter(Boolean);

        if (parts.length !== 3) {
          console.warn("Antwort nicht exakt 3 Teile, erhalten:", parts);
          throw new Error(
            "Die Fairy hat sich verhaspelt. Versuch es bitte noch einmal."
          );
        }

        currentSentences = parts;
        currentSentenceIndex = 0;

        storyText.textContent = currentSentences[0];
        storyHint.textContent = "Drück auf WEITER, um den nächsten Satz zu sehen.";
        weiterBtn.disabled = false;
        weiterBtn.classList.remove("disabled-vis");
        statusLine.textContent = "";
        statusLine.classList.remove("ok");
      } catch (err) {
        console.error(err);
        storyText.textContent =
          "Die Fairy hat sich im Nebel verirrt.";
        storyHint.textContent = "Bitte Internetverbindung und API-Key prüfen.";
        showError("Fehler beim Laden der Fairy (Internet oder API-Key prüfen).");
        resetStoryState();
      } finally {
        setLoadingFairy(false);
      }
    }

    // ------- WEITER drücken -------
    function handleWeiterClick() {
      if (!currentSentences.length) return;
      if (currentSentenceIndex >= currentSentences.length - 1) {
        // Wir waren bereits beim letzten Satz, nichts mehr tun
        return;
      }

      currentSentenceIndex += 1;

      storyText.textContent = currentSentences[currentSentenceIndex];

      if (currentSentenceIndex === currentSentences.length - 1) {
        // Lösungssatz – Punkt geben
        toldFairies += 1;
        points += 1;
        updatePointsUI();
        storyHint.textContent =
          "Das war die Auflösung. Starte bei Bedarf eine neue Fairy mit dem KIPP-Würfel.";
        weiterBtn.disabled = true;
        weiterBtn.classList.add("disabled-vis");
      }
    }

    // ------- Events anschließen -------
    apiKeySaveBtn.addEventListener("click", saveApiKey);
    apiKeyInput.addEventListener("keydown", (ev) => {
      if (ev.key === "Enter") {
        ev.preventDefault();
        saveApiKey();
      }
    });

    fairyBtn.addEventListener("click", () => {
      if (isLoadingFairy) return;
      fetchFairyFromOpenAI();
    });

    weiterBtn.addEventListener("click", handleWeiterClick);

    // ------- Start -------
    loadApiKeyFromStorage();
    updatePointsUI();
  </script>
</body>
</html>
