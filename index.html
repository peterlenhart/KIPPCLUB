<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Fairy KIPP – Unendlich viele KIPP-Geschichten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Fonts für "Fairy" (Handscript) + "KIPP" (technisch) -->
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg-dark: #050505;
      --panel-dark: #111111;
      --panel-mid: #181818;
      --panel-border: #2b2b2b;

      /* deine Vierfarben – bitte bei Bedarf exakt anpassen */
      --fairy-orange: #f9961e; /* leuchtendes Orange für Fairy-Button und Logo */
      --fairy-violet: rgb(164, 27, 133); /* dein Violett */
      --fairy-blue: rgb(0, 107, 179);
      --fairy-green: rgb(0, 166, 82);

      --text-main: #ffffff;
      --text-muted: #c0c0c0;
      --text-pink: #ff4fcf;
      --error-red: #ff4f6b;

      --radius-large: 20px;
      --radius-medium: 14px;
      --shadow-soft: 0 0 35px rgba(0,0,0,0.7);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Roboto', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top, #1a1a1a 0, #000000 45%, #000000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 18px 8px 24px;
    }

    .app {
      width: 100%;
      max-width: 480px;
      background: linear-gradient(150deg, #090909 0, #050505 40%, #0a0a0a 100%);
      border-radius: 26px;
      box-shadow: var(--shadow-soft);
      padding: 18px 16px 20px;
      border: 1px solid #222;
    }

    /* Kopfbereich */
    .header {
      text-align: center;
      margin-bottom: 14px;
    }

    .logo-line {
      display: flex;
      justify-content: center;
      align-items: baseline;
      gap: 6px;
      margin-bottom: 2px;
    }

    .logo-fairy {
      font-family: 'Pacifico', cursive;
      font-size: 34px;
      letter-spacing: 0.04em;
      color: var(--fairy-orange);
      text-shadow: 0 0 10px rgba(249,150,30,0.65);
    }

    .logo-kipp {
      font-family: 'Roboto', sans-serif;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--fairy-blue);
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-muted);
      letter-spacing: 0.04em;
    }

    /* API-Key-Leiste oben */
    .apikey-bar {
      margin: 10px 0 14px;
      padding: 8px 10px;
      border-radius: 999px;
      background: #111;
      border: 1px solid #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .apikey-label {
      font-size: 11px;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .apikey-input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-main);
      font-size: 12px;
    }

    .apikey-input::placeholder {
      color: #555;
    }

    .apikey-btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 6px 11px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      background: var(--fairy-violet);
      color: #fff;
      box-shadow: 0 0 10px rgba(164,27,133,0.7);
    }

    .apikey-btn:active {
      transform: scale(0.97);
      box-shadow: 0 0 3px rgba(164,27,133,0.9);
    }

    /* Haupt-Panel */
    .panel {
      background: radial-gradient(circle at top, #191919 0, #101010 40%, #050505 100%);
      border-radius: 24px;
      padding: 16px 14px 16px;
      border: 1px solid var(--panel-border);
      box-shadow: inset 0 0 25px rgba(0,0,0,0.6);
      margin-bottom: 14px;
    }

    /* Fairy-Button */
    .fairy-btn {
      width: 100%;
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 16px 10px;
      margin-bottom: 14px;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      text-align: center;
      background: radial-gradient(circle at top, #fbb040 0, #f9961e 35%, #f57c00 100%);
      color: #111;
      text-shadow: 0 1px 0 rgba(255,255,255,0.5);
      box-shadow:
        0 14px 26px rgba(0,0,0,0.9),
        0 0 24px rgba(249,150,30,0.8);
    }

    .fairy-btn:active {
      transform: translateY(1px);
      box-shadow:
        0 8px 14px rgba(0,0,0,0.85),
        0 0 12px rgba(249,150,30,0.75);
    }

    /* Text-Card */
    .fairy-card {
      margin-top: 4px;
      background: #141414;
      border-radius: 18px;
      border: 1px solid #2a2a2a;
      padding: 16px 14px 14px;
      min-height: 120px;
      position: relative;
      overflow: hidden;
    }

    .fairy-text {
      font-size: 17px;          /* größer für ältere Augen */
      line-height: 1.45;
      color: #f0f0f0;
    }

    .fairy-hint {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Weiter-Button */
    .actions-row {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
    }

    .next-btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 8px 22px;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      background: var(--fairy-violet);
      color: #ffffff;
      box-shadow: 0 0 14px rgba(164,27,133,0.9);
    }

    .next-btn:disabled {
      opacity: 0.4;
      box-shadow: none;
    }

    .next-btn:active:not(:disabled) {
      transform: translateY(1px);
      box-shadow: 0 0 6px rgba(164,27,133,0.9);
    }

    /* Punkte-Panel */
    .score-panel {
      background: #101010;
      border-radius: 22px;
      border: 1px solid #262626;
      padding: 12px 14px 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .score-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .score-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-pink);
    }

    .score-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .score-big {
      margin-top: 6px;
      font-size: 34px;        /* deutlich größer */
      font-weight: 800;
      color: var(--fairy-orange);
      text-align: left;
      text-shadow: 0 0 10px rgba(249,150,30,0.7);
    }

    .score-detail {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Fehlermeldung */
    .error {
      margin-top: 8px;
      font-size: 12px;
      color: var(--error-red);
    }

    /* kleine Helfer */
    .hidden { display: none; }

    @media (max-width: 380px) {
      .logo-fairy { font-size: 30px; }
      .logo-kipp { font-size: 24px; letter-spacing: 0.12em; }
      .fairy-text { font-size: 16px; }
      .score-big { font-size: 30px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="logo-line">
        <div class="logo-fairy">Fairy</div>
        <div class="logo-kipp">KIPP</div>
      </div>
      <div class="subtitle">Unendlich viele KIPP-Geschichten</div>
    </header>

    <!-- API-Key-Leiste -->
    <div class="apikey-bar">
      <span class="apikey-label">OpenAI API-Key:</span>
      <input
        id="apikey-input"
        class="apikey-input"
        type="password"
        autocomplete="off"
        placeholder="sk-… (einmalig einfügen)"
      />
      <button id="apikey-save" class="apikey-btn">OK</button>
    </div>

    <!-- Haupt-Panel mit Fairy-Button und Text -->
    <section class="panel">
      <button id="fairy-btn" class="fairy-btn">FAIRY</button>

      <div class="fairy-card">
        <div id="fairy-text" class="fairy-text">
          Tippe auf FAIRY, um eine neue Geschichte zu starten.
        </div>
        <div id="fairy-hint" class="fairy-hint">
          Die Fairy kommt in drei kurzen Sätzen. Drück nach jedem Satz auf WEITER.
        </div>
      </div>

      <div class="actions-row">
        <button id="next-btn" class="next-btn" disabled>WEITER</button>
      </div>

      <div id="error" class="error hidden"></div>
    </section>

    <!-- Punkte-Bereich -->
    <section class="score-panel">
      <div class="score-header">
        <div class="score-title">Fairy-Punkte</div>
        <div class="score-sub">
          Erzählte Fairies:
          <span id="fairy-count">0</span>
          / 6
        </div>
      </div>
      <div id="score-big" class="score-big">0</div>
      <div class="score-detail">
        Jede erzählte Fairy bringt einen Punkt. Sammle so viele wie möglich.
      </div>
    </section>
  </div>

  <script>
    // ***** Grundkonfiguration *****
    const MODEL_NAME = "gpt-5-mini";   // günstiges Modell für viele kurze Geschichten
    const FAIRY_MAX_SENTENCES = 3;     // wir wollen genau 3 Sätze pro Fairy
    const SENTENCES_PER_STEP = 1;      // 1 Satz pro WEITER-Klick

    let openAIApiKey = "";
    let fullFairyText = "";
    let sentences = [];
    let currentSentenceIndex = 0;
    let fairyCount = 0;

    const apikeyInput = document.getElementById("apikey-input");
    const apikeySaveBtn = document.getElementById("apikey-save");
    const fairyBtn = document.getElementById("fairy-btn");
    const fairyTextEl = document.getElementById("fairy-text");
    const fairyHintEl = document.getElementById("fairy-hint");
    const nextBtn = document.getElementById("next-btn");
    const errorEl = document.getElementById("error");
    const fairyCountEl = document.getElementById("fairy-count");
    const scoreBigEl = document.getElementById("score-big");

    // ***** API-Key in localStorage merken *****
    function loadStoredKey() {
      try {
        const stored = localStorage.getItem("fairy_kipp_apikey");
        if (stored) {
          openAIApiKey = stored;
          apikeyInput.value = "••••••••••"; // nicht im Klartext anzeigen
        }
      } catch (e) {
        console.warn("Konnte API-Key nicht aus localStorage lesen.", e);
      }
    }

    function saveKeyFromInput() {
      const value = apikeyInput.value.trim();
      if (!value || value === "••••••••••") {
        showError("Bitte einen gültigen OpenAI API-Key eingeben.");
        return;
      }
      openAIApiKey = value;
      try {
        localStorage.setItem("fairy_kipp_apikey", value);
      } catch (e) {
        console.warn("Konnte API-Key nicht speichern.", e);
      }
      showError(""); // Fehlermeldung zurücksetzen
      apikeyInput.value = "••••••••••";
    }

    apikeySaveBtn.addEventListener("click", saveKeyFromInput);

    // ***** Hilfsfunktionen *****
    function showError(msg) {
      if (!msg) {
        errorEl.textContent = "";
        errorEl.classList.add("hidden");
      } else {
        errorEl.textContent = msg;
        errorEl.classList.remove("hidden");
      }
    }

    function updateScore() {
      fairyCountEl.textContent = fairyCount.toString();
      scoreBigEl.textContent = fairyCount.toString();
    }

    // Text in Einzelsätze zerlegen (einfach, aber robust genug)
    function splitIntoSentences(text) {
      return text
        .replace(/\s+/g, " ")
        .trim()
        .split(/(?<=[.!?])\s+/)
        .filter(s => s.length > 0);
    }

    // ***** Prompt für kurze KIPP-Fairy *****
    function buildFairyPrompt() {
      return `
Du bist eine kreative Märchenerzählerin für ein Familien-Kipp-Spiel mit Kindern ab sieben Jahren.

Schreibe eine sehr kurze, dreiteilige KIPP-Fairy auf Deutsch:
- maximal **drei Sätze insgesamt**
- Satz 1: eine stimmungsvolle, leicht magische Metapher oder Bild, ohne das Kipp-Symbol zu nennen
- Satz 2: ein weiterer kurzer Hinweis, der das Bild klarer macht, aber das Symbol noch nicht direkt verrät
- Satz 3: eine klare Auflösung, die das Symbol, die Farbe oder den Gegenstand eindeutig nennt
- jeder Satz soll kurz sein (maximal 18 Wörter)
- keine grausamen, ängstigenden oder zu kitschigen Formulierungen
- Zielgruppe: gemischte Familienrunde, humorvoll verspielt, aber nicht zu kindlich

Gib nur den reinen Text mit genau drei Sätzen zurück, keine Aufzählungszeichen, keine Anführungszeichen, keine Erklärungen.
      `.trim();
    }

    // ***** Aufruf der OpenAI-API *****
    async function fetchNewFairy() {
      if (!openAIApiKey || openAIApiKey === "••••••••••") {
        showError("Kein API-Key hinterlegt. Bitte oben deinen OpenAI API-Key eintragen und OK tippen.");
        return;
      }

      showError("");
      fairyBtn.disabled = true;
      nextBtn.disabled = true;
      fairyTextEl.textContent = "Die Fairy sammelt ihre Funken im Wald … bitte kurz warten.";
      fairyHintEl.textContent = "";

      try {
        const response = await fetch("https://api.openai.com/v1/responses", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + openAIApiKey
          },
          body: JSON.stringify({
            model: MODEL_NAME,
            input: buildFairyPrompt(),
            max_output_tokens: 220
          })
        });

        if (!response.ok) {
          throw new Error("API-Fehler: " + response.status + " " + response.statusText);
        }

        const data = await response.json();
        const out = data.output?.[0]?.content?.[0]?.text || data.output_text || "";

        if (!out || out.length < 10) {
          throw new Error("Leere Antwort der Fairy.");
        }

        fullFairyText = out.trim();
        sentences = splitIntoSentences(fullFairyText);

        if (sentences.length === 0) {
          throw new Error("Die Fairy hat heute keine Sätze gefunden.");
        }

        // Nur maximal FAIRY_MAX_SENTENCES Sätze verwenden
        sentences = sentences.slice(0, FAIRY_MAX_SENTENCES);
        currentSentenceIndex = 0;

        // Ersten Satz anzeigen
        fairyTextEl.textContent = sentences[0];
        fairyHintEl.textContent = "Drück WEITER, um den nächsten Fairy-Satz zu hören.";
        nextBtn.disabled = sentences.length <= 1;

        fairyBtn.disabled = false;
      } catch (err) {
        console.error(err);
        fairyBtn.disabled = false;
        fairyTextEl.textContent = "Die Fairy hat sich im Nebel verirrt.";
        fairyHintEl.textContent = "";
        showError("Fehler beim Laden der Fairy (Internet oder API-Key prüfen).");
      }
    }

    // WEITER → nächsten Satz anzeigen oder Fairy beenden
    function showNextSentence() {
      if (!sentences || sentences.length === 0) return;

      currentSentenceIndex += SENTENCES_PER_STEP;
      if (currentSentenceIndex >= sentences.length) {
        // Fairy fertig erzählt
        fairyHintEl.textContent = "Die Fairy ist zu Ende – du kannst eine neue Fairy starten.";
        nextBtn.disabled = true;
        fairyCount += 1;
        updateScore();
        return;
      }

      fairyTextEl.textContent = sentences[currentSentenceIndex];
      if (currentSentenceIndex >= sentences.length - 1) {
        fairyHintEl.textContent = "Der nächste Satz bringt die Auflösung.";
      } else {
        fairyHintEl.textContent = "Noch ein Hinweis – drück wieder auf WEITER.";
      }

      nextBtn.disabled = currentSentenceIndex >= sentences.length - 1;
    }

    fairyBtn.addEventListener("click", fetchNewFairy);
    nextBtn.addEventListener("click", showNextSentence);

    // Start-Setup
    loadStoredKey();
    updateScore();
  </script>
</body>
</html>
