<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Fairy KIPP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Verspielte Schrift für "Fairy" -->
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --color-orange: rgb(242, 150, 0);
      --color-blue:   rgb(0, 101, 171);
      --color-violet: rgb(170, 0, 120);
      --color-green:  rgb(59, 165, 43);
      --color-light:  rgb(191, 212, 188);

      --bg-dark:  #181a20;
      --card-dark:#22252b;
      --text-main:#f5f6fa;
      --text-muted:#a7acb8;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Nunito", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #262a33 0, var(--bg-dark) 55%, #101116 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 420px;
    }

    .card {
      background: var(--card-dark);
      border-radius: 24px;
      padding: 20px 18px 24px;
      box-shadow:
        0 18px 35px rgba(0, 0, 0, 0.6),
        0 0 0 2px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
    }

    .title {
      text-align: center;
      margin-bottom: 16px;
      letter-spacing: 0.06em;
      font-size: 1.6rem;
      font-weight: 700;
    }

    .title-fairy {
      font-family: "Pacifico", cursive;
      color: var(--color-orange);
      font-size: 1.8rem;
      margin-right: 4px;
    }

    .title-kipp {
      color: var(--color-blue);
    }

    .subtitle {
      text-align: center;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
      margin-bottom: 18px;
    }

    .primary-button,
    .secondary-button,
    .fund-button {
      width: 100%;
      padding: 12px 10px;
      border-radius: 12px;           /* eckig, aber nicht scharf */
      border: none;
      font-weight: 700;
      font-size: 1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.1s ease;
    }

    .primary-button {
      background: var(--color-orange);
      color: #151515;
      box-shadow:
        0 0 0 1px rgba(0,0,0,0.4),
        0 0 18px rgba(242, 150, 0, 0.7);
      margin-bottom: 18px;
    }

    .primary-button:active {
      transform: translateY(1px);
      box-shadow:
        0 0 0 1px rgba(0,0,0,0.6),
        0 0 10px rgba(242, 150, 0, 0.4);
    }

    .story-box {
      background: #2a2d36;
      border-radius: 18px;
      padding: 14px 14px 16px;
      margin-bottom: 12px;
      min-height: 90px;
      display: flex;
      align-items: center;
    }

    #storyText {
      font-size: 0.95rem;
      line-height: 1.4;
      color: var(--text-main);
    }

    .secondary-button {
      background: var(--color-violet);
      color: #fff;
      max-width: 160px;
      margin: 0 auto 18px;
      display: block;
    }

    .secondary-button:disabled {
      opacity: 0.35;
      cursor: default;
      box-shadow: none;
    }

    .fund-button {
      background: var(--color-green);
      color: #101010;
      margin-bottom: 20px;
    }

    .fund-button:disabled {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
    }

    .fund-button:active,
    .secondary-button:active {
      transform: translateY(1px);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.45);
    }

    .scoreboard {
      text-align: center;
      padding-top: 4px;
    }

    .score-label {
      font-size: 0.75rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .score-value {
      font-size: 2.6rem;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .fairies-info {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .hidden {
      display: none !important;
    }

    /* End-Screen Overlay */
    .end-overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(0,0,0,0.1), rgba(0,0,0,0.92));
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 24px 18px;
    }

    .end-title {
      letter-spacing: 0.18em;
      font-size: 1rem;
      text-transform: uppercase;
      color: var(--color-light);
      margin-bottom: 8px;
    }

    .end-score {
      font-size: 3rem;
      font-weight: 700;
      margin-bottom: 18px;
    }

    .restart-button {
      max-width: 210px;
    }

    @media (max-width: 350px) {
      .card {
        padding: 16px 12px 20px;
      }
      .title {
        font-size: 1.4rem;
      }
      .title-fairy {
        font-size: 1.6rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="title">
        <span class="title-fairy">Fairy</span>
        <span class="title-kipp">KIPP</span>
      </div>
      <div class="subtitle">
        Unendlich viele Kipp-Geschichten
      </div>

      <button id="fairyButton" class="primary-button">FAIRY</button>

      <div id="storyBox" class="story-box hidden">
        <p id="storyText"></p>
      </div>

      <button id="nextButton" class="secondary-button hidden">Weiter</button>

      <button id="fundButton" class="fund-button" disabled>FAIRY-FUND</button>

      <div class="scoreboard">
        <div class="score-label">Fairy-Punkte</div>
        <div id="scoreValue" class="score-value">0</div>
        <div id="fairiesInfo" class="fairies-info">Erzählte Fairies: 0 / 6</div>
      </div>

      <!-- End-Screen -->
      <div id="endOverlay" class="end-overlay hidden">
        <div class="end-title">Fairy-End</div>
        <div id="endScore" class="end-score">0</div>
        <button id="restartButton" class="secondary-button restart-button">
          Neues Spiel
        </button>
      </div>
    </div>
  </div>

  <script>
    // ---------- KONSTANTEN & STATE ----------

    const MAX_FAIRIES = 6;
    const STORAGE_KEY = "fairyKippUsedStoriesV1";
    const MAX_STORED_STORIES = 500; // so gut wie keine Wiederholung

    let usedStories = [];
    let currentStory = null;      // { parts: [s1,s2,s3], id: "..."}
    let currentPartIndex = 0;
    let score = 0;
    let narratedFairies = 0;
    let isNarratorForCurrentFairy = false;
    let canScoreThisFairy = false;
    let gameEnded = false;

    // ---------- DOM-ELEMENTE ----------

    const fairyButton   = document.getElementById("fairyButton");
    const storyBox      = document.getElementById("storyBox");
    const storyTextEl   = document.getElementById("storyText");
    const nextButton    = document.getElementById("nextButton");
    const fundButton    = document.getElementById("fundButton");
    const scoreValueEl  = document.getElementById("scoreValue");
    const fairiesInfoEl = document.getElementById("fairiesInfo");
    const endOverlay    = document.getElementById("endOverlay");
    const endScoreEl    = document.getElementById("endScore");
    const restartButton = document.getElementById("restartButton");

    // ---------- PERSISTENZ FÜR EINZIGARTIGE FAIRIES ----------

    function loadUsedStories() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const arr = JSON.parse(raw);
          if (Array.isArray(arr)) usedStories = arr;
        }
      } catch (e) {
        usedStories = [];
      }
    }

    function saveUsedStories() {
      try {
        if (usedStories.length > MAX_STORED_STORIES) {
          usedStories = usedStories.slice(-MAX_STORED_STORIES);
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(usedStories));
      } catch (e) {
        // egal – dann ist die Sitzung halt flüchtig
      }
    }

    loadUsedStories();

    // ---------- TEXTBAUSTEINE ----------

    const intros = [
      "Der Abend legte sich wie ein flüsternder Schleier über den Weg, und irgendwo zwischen den Schatten schien etwas auf einen Moment der Aufmerksamkeit zu warten.",
      "Über dem Boden hing ein feiner Dunst, als hätte jemand die Luft mit einem Hauch von Geheimnis gewürzt.",
      "Zwischen den Bäumen wurde das Licht weicher, als würde der Wald selbst einen tiefen Atemzug nehmen.",
      "Ein leiser Wind strich über den Boden und ließ die Gerüche von Moos, Holz und verborgenen Geschichten aufsteigen.",
      "Die Stille war nicht leer, sondern voller kleiner Geräusche, die so taten, als wären sie zufällig genau hier gelandet.",
      "Ein kaum hörbares Knistern zog durch die Luft, so als würde jemand unsichtbar eine Seite im Buch der Nacht umblättern.",
      "Auf dem Pfad lagen verstreute Blätter, als hätten sie heimlich eine Spur gelegt, die nur neugierige Augen bemerken.",
      "Der Himmel war bereits dunkel, doch am Boden funkelten vereinzelte Lichtpunkte, als hätten Sterne beschlossen, näher zu kommen."
    ];

    const motifs = [
      {
        key: "wasserball",
        noun: "Wasserball",
        gender: "m",
        hints: [
          "In einer Pfütze spiegelten sich bunte Ringe, als wäre ein Stück Sommer einfach dort liegen geblieben.",
          "Zwischen den Tropfen des Morgentaus schimmerte eine runde Form mit wirbelnden Streifen.",
          "Ein kurzer Spritzer traf den Weg, obwohl niemand weit und breit zu sehen war."
        ]
      },
      {
        key: "auto",
        noun: "Auto",
        gender: "n",
        hints: [
          "Am Boden verlief eine schmale Spur, als wäre eben noch jemand leise davongerollt.",
          "Ein paar kleine Steinchen lagen so, als wären sie von etwas Schwerem zur Seite gedrückt worden.",
          "In der Luft hing ein Hauch von Metall und Staub, der schnell wieder verflog."
        ]
      },
      {
        key: "farbfleck",
        noun: "Farbfleck",
        gender: "m",
        hints: [
          "Auf einem Stein glänzte ein kleiner Spritzer, als hätte jemand heimlich gemalt.",
          "Der Boden sah an einer Stelle aus, als wäre dort ein geheimer Pinsel abgewischt worden.",
          "Zwischen den matten Tönen leuchtete plötzlich ein winziger Tupfer auf."
        ]
      },
      {
        key: "buch",
        noun: "Buch",
        gender: "n",
        hints: [
          "Ein Hauch von Papier und alten Geschichten schwebte in der Luft.",
          "Ganz in der Nähe hörte es sich an, als würden unsichtbare Seiten leise umblättern.",
          "Der Staub auf dem Boden wirkte, als hätte er einmal in geraden Zeilen auf etwas gesessen."
        ]
      },
      {
        key: "giesskanne",
        noun: "Gießkanne",
        gender: "f",
        hints: [
          "Ein feiner Bogen aus Tropfen zeichnete eine Spur, die im Schatten verschwand.",
          "Dort, wo der Boden trocken hätte sein sollen, war er überraschend frisch und dunkel.",
          "Leises Tröpfeln war zu hören, obwohl weit und breit kein Regen fiel."
        ]
      },
      {
        key: "kerze",
        noun: "Kerze",
        gender: "f",
        hints: [
          "Ein fast unsichtbarer Duft von Wachs mischte sich unter die Abendluft.",
          "Es roch nach einem Raum, in dem jemand still gewünscht und lange geschwiegen hatte.",
          "Ein flackernder Schein spiegelte sich in einem Fenster, obwohl kein Feuer zu sehen war."
        ]
      },
      {
        key: "blume",
        noun: "Blume",
        gender: "f",
        hints: [
          "Zwischen den Steinen hing ein Duft, der nicht zum kühlen Boden passen wollte.",
          "Ein winziger Hauch von Frühling hielt sich hartnäckig in der Luft.",
          "Dort, wo alles grau wirkte, schien die Luft für einen Moment weicher zu werden."
        ]
      },
      {
        key: "fisch",
        noun: "Fisch",
        gender: "m",
        hints: [
          "Aus einer unscheinbaren Mulde war ein kurzes Plätschern zu hören.",
          "Ein schmaler Schatten glitt unter einer Wasseroberfläche, die eben noch still gewesen war.",
          "Der Geruch von Wasser und einem fernen See mischte sich plötzlich unter die Nacht."
        ]
      },
      {
        key: "schmetterling",
        noun: "Schmetterling",
        gender: "m",
        hints: [
          "Etwas Leichtes strich an der Schulter vorbei, ohne wirklich Gewicht zu haben.",
          "In der Luft tanzte ein winziges Flimmern, das immer wieder aus dem Blick huschte.",
          "Ein Schatten huschte über den Boden, als würde jemand mit farbigen Flügeln spielen."
        ]
      },
      {
        key: "schuh",
        noun: "Schuh",
        gender: "m",
        hints: [
          "Neben den tiefen Fußspuren lag eine einzelne, kleinere Spur, die plötzlich endete.",
          "Der Boden wirkte, als wäre hier jemand stehen geblieben und einfach verschwunden.",
          "Ein leichter Geruch nach nassem Leder lag für einen Moment in der Luft."
        ]
      },
      {
        key: "tasse",
        noun: "Tasse",
        gender: "f",
        hints: [
          "Ganz kurz war der Duft von warmem Getränk zu riechen, obwohl niemand etwas bei sich hatte.",
          "Ein kleiner Kreis auf dem Stein wirkte, als hätte dort etwas Rundes gestanden.",
          "An einer Stelle sah der Rand eines Felsens so glatt aus, als würde dort gern jemand eine Pause machen."
        ]
      },
      {
        key: "tshirt",
        noun: "T-Shirt",
        gender: "n",
        hints: [
          "Im Wind flatterte etwas Weiches, als hätte es eben noch Schultern gewärmt.",
          "Zwischen den Zweigen hing ein Stück Stoffgeräusch, das sich wie ein leiser Aufschlag anhörte.",
          "Der Geruch von Sonne auf Stoff tauchte ganz für einen Moment wieder auf."
        ]
      }
    ];

    const colors = [
      { name: "Blau" },
      { name: "Grün" },
      { name: "Orange" },
      { name: "Violett" }
    ];

    const colorAdjectives = [
      "leuchtendem",
      "sanftem",
      "tiefem",
      "schimmernden",
      "glimmendem",
      "strahlendem",
      "weichem"
    ];

    const revealTemplates = [
      "Am Ende des Weges lag {article} {noun} in {adj} {color}.",
      "In einer versteckten Ecke wartete {article} {noun} in {adj} {color}.",
      "Dort, wo der Schatten am dichtesten war, fand sich {article} {noun} in {adj} {color}.",
      "Ganz nah am Rand des Lichts ruhte {article} {noun} in {adj} {color}."
    ];

    function pick(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function buildRevealSentence(motif, colorName) {
      const article = motif.gender === "f" ? "eine" : "ein";
      const adj = pick(colorAdjectives);
      let sentence = pick(revealTemplates);
      sentence = sentence
        .replace("{article}", article)
        .replace("{noun}", motif.noun)
        .replace("{adj}", adj)
        .replace("{color}", colorName);
      return sentence;
    }

    function generateFairyStoryOnce() {
      const intro = pick(intros);
      const motif = pick(motifs);
      const color = pick(colors);
      const hint = pick(motif.hints);
      const reveal = buildRevealSentence(motif, color.name);

      const parts = [intro, hint, reveal];
      const id = parts.join(" | ");

      return { parts, id };
    }

    // erzeugt eine Fairy, die in dieser Sitzung & im lokalen Speicher
    // noch nicht vorkam (bis zu maxVersuche).
    function generateUniqueFairy(maxTries = 40) {
      let story = generateFairyStoryOnce();
      let tries = 0;

      while (usedStories.includes(story.id) && tries < maxTries) {
        story = generateFairyStoryOnce();
        tries++;
      }

      // jetzt akzeptieren wir diese Fairy als neu genug
      usedStories.push(story.id);
      saveUsedStories();
      return story;
    }

    // ---------- UI-HILFSFUNKTIONEN ----------

    function updateScoreboard() {
      scoreValueEl.textContent = score.toString();
      fairiesInfoEl.textContent = `Erzählte Fairies: ${narratedFairies} / ${MAX_FAIRIES}`;
    }

    function showStoryPart() {
      if (!currentStory) return;
      storyTextEl.textContent = currentStory.parts[currentPartIndex];
      storyBox.classList.remove("hidden");

      if (currentPartIndex < currentStory.parts.length - 1) {
        nextButton.classList.remove("hidden");
        fundButton.disabled = true;
        canScoreThisFairy = false;
      } else {
        nextButton.classList.add("hidden");
        fundButton.disabled = false;
        canScoreThisFairy = true;
      }
    }

    function startNewFairy() {
      if (gameEnded) return;
      if (narratedFairies >= MAX_FAIRIES) return;

      // solange eine Fairy aktiv ist, nicht neu starten
      if (currentStory && canScoreThisFairy) {
        return;
      }

      currentStory = generateUniqueFairy();
      currentPartIndex = 0;
      isNarratorForCurrentFairy = true;
      narratedFairies += 1;

      updateScoreboard();
      showStoryPart();
    }

    function goToNextPart() {
      if (!currentStory) return;
      if (currentPartIndex < currentStory.parts.length - 1) {
        currentPartIndex++;
        showStoryPart();
      }
    }

    function claimFairyFund() {
      if (!canScoreThisFairy || !currentStory) return;
      if (gameEnded) return;

      // Punkte-Logik:
      // dieses Handy hat die Fairy gestartet -> 3 Punkte
      // sonst (Fremd-Fairy getroffen oder aufgelegt) -> 2 Punkte
      const gained = isNarratorForCurrentFairy ? 3 : 2;
      score += gained;

      // aktuelle Fairy abschließen
      currentStory = null;
      canScoreThisFairy = false;
      isNarratorForCurrentFairy = false;

      storyBox.classList.add("hidden");
      fundButton.disabled = true;
      nextButton.classList.add("hidden");
      updateScoreboard();

      if (narratedFairies >= MAX_FAIRIES) {
        showEndScreen();
      }
    }

    function showEndScreen() {
      gameEnded = true;
      endScoreEl.textContent = score.toString();
      endOverlay.classList.remove("hidden");
      fairyButton.disabled = true;
      fundButton.disabled = true;
      nextButton.disabled = true;
    }

    function resetGame() {
      score = 0;
      narratedFairies = 0;
      currentStory = null;
      currentPartIndex = 0;
      isNarratorForCurrentFairy = false;
      canScoreThisFairy = false;
      gameEnded = false;

      storyBox.classList.add("hidden");
      nextButton.classList.add("hidden");
      fundButton.disabled = true;
      fairyButton.disabled = false;

      updateScoreboard();

      endOverlay.classList.add("hidden");
    }

    // ---------- EVENT-LISTENER ----------

    fairyButton.addEventListener("click", startNewFairy);
    nextButton.addEventListener("click", goToNextPart);
    fundButton.addEventListener("click", claimFairyFund);
    restartButton.addEventListener("click", resetGame);

    // Initialer Zustand
    updateScoreboard();
  </script>
</body>
</html>
